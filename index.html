<!DOCTYPE html> 
  <html>
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta charset='UTF-8' name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=0'>
      <title>Web-IRC</title>
      <link rel="stylesheet" href="style.css">
      <script src="DragDropTouch.js"></script>
      <script src="ircclient.js"></script>
      <script src="Qtv5.js"></script>
      <script>
if (Array.prototype.forEachReverse === undefined) { 
  Object.defineProperty(Array.prototype, 'forEachReverse', { 
      writable : false,
      enumerable : false,
      configurable : false,
      value : function (func) { for (var i = this.length-1; i >= 0; i--) { func(this[i], i, this); } }
  });
}
//array.reduceRight((_, elem) => console.log(elem), null);
window.mobileCheck = function() {
  var check = false;
  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
  return check;
};

/* Test multi-server
/server -i Talon -j #javascript,#swiftirc,#programming,#minecraft wss://fiery.swiftirc.net:4443
/server -i Talon -j #mIRC,#adiirc,#libera,#shrewsburyfromwhereyouarenot -m wss://web.libera.chat/webirc/websocket/
/server -i Talon -j #mircscripts.info,#mirc,#help -m ws://irc.mircscripts.info:8000
/server -i Talon -j #krysti -m wss://irc.wrestlingnewssource.com:8000
*/

function AscTime(date,format) {
  let DayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"] , MonthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  let Second = date.getSeconds(), Minute = date.getMinutes(), Hour = date.getHours(), Day = date.getDay(), Month = date.getMonth(), Year = date.getFullYear(), OffsetHrs = date.getTimezoneOffset() / -60, OffsetMns = (Math.abs(OffsetHrs) % 1 * 60).toString().padStart(2,0);
  OffsetHrs = parseInt(OffsetHrs);
  return format.replace(/(yy(?:yy)?|m{1,4}|d{1,4}|z{1,3}|HH?|hh?|nn?|ss?|TT?|tt?)/g, function(m,i) {
    let chr = i.substr(0,1);
    if (chr == "y") { return Year.toString().substr((i.length <= 2 ? 2 : 0)); }
    else if (chr == "m") { return (i.length < 3 ? (Month + 1).toString().padStart(i.length,0) : (i.length < 4 ? MonthNames[Month].substring(0,i.length) : MonthNames[Month])); }
    else if (chr == "d") { return (i.length < 3 ? date.getDate().toString().padStart(i.length,0) : (i.length < 4 ? DayNames[Day].substring(0,i.length) : DayNames[Day])); }
    else if (chr == "H") { return (i.length == 2 ? Hour.toString().padStart(2,0) : Hour); }
    else if (chr == "h") { return (Hour < 12 ? (i.length == 2 ? Hour.toString().padStart(2,0) : Hour) : (i.length == 2 ? (Hour - 12).toString().padStart(2,0) : (Hour - 12))); }
    else if (chr == "n") { return (i.length == 2 ? Minute.toString().padStart(2,0) : Minute); }
    else if (chr == "s") { return (i.length == 2 ? Second.toString().padStart(2,0) : Second); }
    else if (chr == "T") { return (Hour < 12 ? "AM" : "PM").substr(0,i.length); }
    else if (chr == "t") { return (Hour < 12 ? "am" : "pm").substr(0,i.length); }
    else if (chr == "z") { return (OffsetHrs < 0 ? '-' : '+') + (i.length < 3 ? (i.length == 1 ? Math.abs(OffsetHrs) : Math.abs(OffsetHrs).toString().padStart(2,0) + OffsetMns) : Math.abs(OffsetHrs).toString().padStart(2,0) + OffsetMns + " GMT"); }
  }).replace(/(1?\d)oo/g,function(m,i) { return i + ([0,'st','nd','rd'][i]||'th'); });  
}

function AsyncEmbed(id) {
  var elem = document.getElementById(id);
  if (elem) {
    var url = elem.innerText;
    return new Promise((res, rej) => {
      if (/\.(?:bmp|cgm|g3|gif|ief|jpe?g?|png|btif|svgz?|tiff?|psd|djvu?|dwg|dxf|fbs|fpx|fst|mmr|rlc|mdi|npx|wbmp|xif|ras|cmx|ico|pcx|pic|pct|pnm|pbm|pgm|ppm|rgb|xbm|xpm|xwd)$/i.test(url)) {
        var img = document.createElement('img');
        img.addEventListener('load',() => { res({type: 'image', data: img, src: url}); });
        img.addEventListener('error',() => { res({type: 'text', src: url}); });
        img.src = url;
      }
      else if (/\.(?:asf|au|snd|midi?|kar|rmi|mpga|mp?[2-4](?:a|v)?|eol|lvp|ecelp(?:4800|7470|9600)|wav|aiff?c?|m3u|wax|wma|ram?|rmp|3g(?:p|2)|h26(?:1|3|4)|jpg(?:m|v)|jpm|mjp?2|mpe?g?|m[1-2]v|qt|mov|fvt|mxu|m4u|viv|fli|asx|wm(?:v|x)?|wvx|avi|movie)$/i.test(url)) { 
        var video = QuickElement('video',{controls: true, style: "text-indent: 0; max-width: 400px; max-height: 227px;"})
        video.preload='metadata';
        video.onloadedmetadata = (evt) => {
          if (video.videoHeight && video.videoWidth) { res({type: 'video', data: video, src: url}); }
          else { video.src = null; res({type: 'audio', data: QuickElement('audio',{src: url, controls: true, style: "text-indent: 0; max-width: 400px; max-height: 227px;"}) , src: url}); }
        };
        video.src = url;
      }
      else { res({type: 'text', src: url}); }
    });
  }
}

class WebIRC extends QMainWindow {
  constructor() {
    super(null,Qt.WindowType.Window);
    var LocalConfig = window.localStorage.getItem('Web-IRC.Config');
    if (LocalConfig) { this._Config = JSON.parse(LocalConfig); }
    else {
      this._Config = {
        'palette': new Array("#FFFFFF","#000000","#00009D","#009300","#FF0000","#7F0000","#9C009C","#FC7F00","#FFFF00","#00FC00","#009393","#00FFFF","#0000FC","#FF00FF","#7F7F7F","#D2D2D2","#470000","#472100","#474700","#324700","#004700","#00472C","#004747","#002747","#000047","#2E0047","#470047","#47002A","#740000","#743A00","#747400","#517400","#007400","#007449","#007474","#004074","#000074","#4B0074","#740074","#740045","#B50000","#B56300","#B5B500","#7DB500","#00B500","#00B571","#00B5B5","#0063B5","#0000B5","#7500B5","#B500B5","#B5006B","#FF0000","#FF8C00","#FFFF00","#B2FF00","#00FF00","#00FFA0","#00FFFF","#008CFF","#0000FF","#A500FF","#FF00FF","#FF0098","#FF5959","#FFB459","#FFFF71","#CFFF60","#6FFF6F","#65FFC9","#6DFFFF","#59B4FF","#5959FF","#C459FF","#FF66FF","#FF59BC","#FF9C9C","#FFD39C","#FFFF9C","#E2FF9C","#9CFF9C","#9CFFDB","#9CFFFF","#9CD3FF","#9C9CFF","#DC9CFF","#FF9CFF","#FF94D3","#000000","#131313","#282828","#363636","#4D4D4D","#656565","#818181","#9F9F9F","#BCBCBC","#E2E2E2","#FFFFFF","inherit"),
        'colors': {
          'action':7,
          'ctcp':4,
          'highlight':4,
          'info':3,
          'invite':3,
          'join':10,
          'kick':4,
          'mode':4,
          'nick':10,
          'normal':'inherit',
          'notice':7,
          'own':'inherit',
          'part':10,
          'topic':3,
          'quit':12,

          'treebar':'inherit',
          'treebartext':'inherit',
          'mdi':'inherit',
          'viewport':'inherit',
          'listbox':'inherit',
          'listboxtext':'inherit',
          'editbox':'inherit',
          'editboxtext':'inherit',
        },
        'options': { 
          'irc': {
            'ebeeps': false,
            'reconnect': true,
            'showprefix': true,
            'kickrejoin': true,
            'connectrejoin': true,
            'keepchanopen': true,
            'timestamp': true,
            'timestampformat': '[HH:nn]',
            'quitmsg': '',
          }
        },
        'windows': { 
          'event':12,
          'message':4,
          'highlight':9,
          'buffer': 500,
          //'status':{w: 320, h: 240},
          //'channel':{w: 520, h: 340},
          //'query':{w: 320, h: 240},
        },
      };
    }
    this.Sessions = { };
    /*-------------------------------------------------------------------------------------------------
    Build UI Components
    -------------------------------------------------------------------------------------------------*/
    this.setWindowTitle("Web-IRC"); //for giggles just incase we setwindowflags to give back titlehint...

    this.mFile = new QMenu('File');
      this.fNew = new QAction('images/addserver.ico','New Server Window',this.mFile).connect('triggered',this,() => { this._NewSession('','',['text.ircv3.net']); });
      new QAction('','',this.mFile).setSeparator();
      this.fOptions = new QAction('images/options.ico','Options',this.mFile).connect('triggered',this,this._ToggleConfigGeneral);
    this._MenuBar.addMenu(this.mFile);

    this.mView = new QMenu('View');
      this.vFull = new QAction('','Fullscreen',this.mView).connect('triggered',this,this._ToggleFullscreen);
      new QAction('','',this.mView).setSeparator();
      this.vMenu = new QAction('','Menubar',this.mView).setCheckable(true).setChecked(true).connect('toggled',this,this._ToggleMenubar);
      this.vTool = new QAction('','Toolbar',this.mView).setCheckable(true).setChecked(true).connect('toggled',this,this._ToggleToolbar);
      this.vTree = new QAction('','Treebar',this.mView).setCheckable(true).setChecked(true).connect('toggled',this,this._ToggleTreebar);
      this.vStatus = new QAction('','Statusbar',this.mView).setCheckable(true).setChecked(true).connect('toggled',this,this._ToggleStatus);

      new QAction('','',this.mView).setSeparator();
      this.vMPToggle = new QAction('','Toggle All Monitor Panels',this.mView).connect('triggered',this,this._ToggleAll);
      new QAction('','',this.mView).setSeparator();
      this.vChan = new QAction('','Channel Messages',this.mView).setCheckable(true).setChecked(false).connect('toggled',this,this._ToggleChan);
      this.vHighlight = new QAction('','Highlights',this.mView).setCheckable(true).setChecked(false).connect('toggled',this,this._ToggleHighlight);
      this.vNotice = new QAction('','Notices',this.mView).setCheckable(true).setChecked(false).connect('toggled',this,this._ToggleNotice);
      this.vQuery = new QAction('','Private Messages',this.mView).setCheckable(true).setChecked(false).connect('toggled',this,this._ToggleQuery);
      this.vServer = new QAction('','Server Messages',this.mView).setCheckable(true).setChecked(false).connect('toggled',this,this._ToggleServer);
    this._MenuBar.addMenu(this.mView);
    this.mHelp = new QMenu('Help');
      this.hHelp = new QAction('','Help Doc',this.mHelp).setCheckable(true).setChecked(false).connect('toggled',this,this._ToggleHelp);
      this.hAbout = new QAction('','About',this.mHelp).connect('triggered',this,this._ToggleAbout);
    this._MenuBar.addMenu(this.mHelp);

    this.MDI = new QMdiArea(this);
    this.MDI._CurrentWindowState = Qt.WindowState.WindowMaximized;

    this.MDI.style.background = this._Color('mdi');
    //this.SwitchDock = new QDockWidget('Switchbar').setWindowFlag(Qt.WindowType.WindowTitleHint,false);
    //this.addDockWidget(Qt.DockWidgetArea.TopDockWidgetArea,this.SwitchDock);

    this.TreeDock = new QDockWidget('Treebar').setAllowedAreas(Qt.DockWidgetArea.RightDockWidgetArea | Qt.DockWidgetArea.LeftDockWidgetArea).setBaseSize(150,null).setResizable(true);
    this.HelpDock = new QDockWidget('Help').setAllowedAreas(Qt.DockWidgetArea.RightDockWidgetArea | Qt.DockWidgetArea.LeftDockWidgetArea).setBaseSize(300,200).setResizable(true).setVisible(false);
    this.HelpDialog = new QDialog().setBaseSize(270,240).setWindowTitle('About Web-IRC').setWindowFlag(Qt.WindowType.WindowMinMaxButtonsHint,false).hide();
    //this.GeneralDialog = new ConfigGeneral(this).setBaseSize(200,290).setWindowTitle('Web-IRC Preferences').hide();
    //this.ColorsDialog = new ConfigColors(this).setBaseSize(408,290).setWindowTitle('Web-IRC Colors').hide();
    setTimeout(() => {
      this.HelpDialog.setCentralWidget(document.getElementById('helpabout'));
      document.getElementById('helpabout').style.display = "";

      this.HelpDock.setCentralWidget(document.getElementById('helpdoc'));
      document.getElementById('helpdoc').style.display = "";
    });
    this.addDockWidget(Qt.DockWidgetArea.RightDockWidgetArea,this.HelpDock);

    this.Treebar = new QTreeWidget();
    this.Treebar.style.background = this._Color('treebar');
    this.Treebar.style.color = this._Color('treebartext');

    this.TreeDock.setCentralWidget(this.Treebar);
    this.addDockWidget(Qt.DockWidgetArea.LeftDockWidgetArea,this.TreeDock);

    this.MonitorChan = new QDockWidget('Channel Messages').setFeature(Qt.DockWidgetFeature.AllowTabs,true).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorChanViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorChan.setCentralWidget(this.MonitorChanViewPort);
    this.MonitorHighlight = new QDockWidget('Highlights').setFeature(Qt.DockWidgetFeature.AllowTabs,true).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorHighlightViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorHighlight.setCentralWidget(this.MonitorHighlightViewPort);
    this.MonitorNotice = new QDockWidget('Notices').setFeature(Qt.DockWidgetFeature.AllowTabs,true).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorNoticeViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorNotice.setCentralWidget(this.MonitorNoticeViewPort);
    this.MonitorQuery = new QDockWidget('Private Messages').setFeature(Qt.DockWidgetFeature.AllowTabs,true).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorQueryViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorQuery.setCentralWidget(this.MonitorQueryViewPort);
    this.MonitorServer = new QDockWidget('Server Messages').setFeature(Qt.DockWidgetFeature.AllowTabs,true).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorServerViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll; "});
    this.MonitorServer.setCentralWidget(this.MonitorServerViewPort);
    this.MonitorChanViewPort.style.background = this.MonitorHighlightViewPort.style.background = this.MonitorNoticeViewPort.style.background = this.MonitorQueryViewPort.style.background = this.MonitorServerViewPort.style.background = this._Color('viewport');

    this.addDockWidget(Qt.DockWidgetArea.BottomDockWidgetArea,this.MonitorChan);
    this.addDockWidget(Qt.DockWidgetArea.BottomDockWidgetArea,this.MonitorHighlight);
    this.addDockWidget(Qt.DockWidgetArea.BottomDockWidgetArea,this.MonitorQuery);
    this.addDockWidget(Qt.DockWidgetArea.TopDockWidgetArea,this.MonitorServer);
    this.addDockWidget(Qt.DockWidgetArea.TopDockWidgetArea,this.MonitorNotice);

    this.Toolbar = new QToolBar();
    //Need a placeholder so we can change this one
    this.ConnectToggle = new QAction('images/connect.ico').setToolTip('Connect').connect('triggered',this,() => { this._ToggleConnection(); });
    this.Toolbar.addAction(this.ConnectToggle);
    this.Toolbar.addAction(new QAction('','').setSeparator());
    this.Toolbar.addAction(new QAction('images/options.ico').setToolTip('Options').connect('triggered',this,this._ToggleConfigGeneral));
    this.Toolbar.addAction(new QAction('images/colors.ico').setToolTip('Colors').connect('triggered',this,this._ToggleConfigColors));
    this.Toolbar.addAction(new QAction('','').setSeparator());
    this.Toolbar.addAction(new QAction('images/monitor.ico').setToolTip('Toggle Monitor Panels').connect('triggered',this,this._ToggleAll));
    this.addToolBar(Qt.ToolBarArea.TopToolBarArea,this.Toolbar);

    this.TreeDock.addEventListener('visibilityChanged',(e) => { this.vTree.setChecked(e.detail.visible); });
    this.HelpDock.addEventListener('visibilityChanged',(e) => { this.hHelp.setChecked(e.detail.visible); });
    this.MonitorChan.addEventListener('visibilityChanged',(e) => { this.vChan.setChecked(e.detail.visible); });
    this.MonitorHighlight.addEventListener('visibilityChanged',(e) => { this.vHighlight.setChecked(e.detail.visible); });
    this.MonitorNotice.addEventListener('visibilityChanged',(e) => { this.vNotice.setChecked(e.detail.visible); });
    this.MonitorQuery.addEventListener('visibilityChanged',(e) => { this.vQuery.setChecked(e.detail.visible); });
    this.MonitorServer.addEventListener('visibilityChanged',(e) => { this.vServer.setChecked(e.detail.visible); });
    //this.MDI.addEventListener('subWindowActivated',(e) => { this._ToggleConnection(true); });
    this.MDI.addEventListener('childEvent',(e) => { this._ToggleConnection(true); });
    this._NewSession('','',['text.ircv3.net']);
  }
  //handleEvent(e) { super.handleEvent(e); }

  _ToggleConnection(bool) {
    if (this.MDI.activeSubWindow() && this.MDI.activeSubWindow()._Cid) {
      if (this.Sessions[this.MDI.activeSubWindow()._Cid].Windows.hasOwnProperty('status window')) { this.Sessions[this.MDI.activeSubWindow()._Cid].Windows['status window']._SortTree(); }
      var Client = this.Sessions[this.MDI.activeSubWindow()._Cid].Client;
      if (bool) {
        if (Client.hasOwnProperty('Socket') && Client.Socket.readyState < 3) { this.ConnectToggle.setIcon('images/disconnect.ico').setToolTip('Disconnect'); }
        else { this.ConnectToggle.setIcon('images/connect.ico').setToolTip('Connect'); }
      }
      else if (Client) {
        if (Client.hasOwnProperty('Socket') && Client.Socket.readyState < 3) { Client.WSClose(); }
        else { 
          if (Client.WSServerURI && Client.WSServerPROTO && Client.Socket.readyState == 3) {
            Client.ConnectRetry = 1;
            Client.WSConnect(Client.Me,Client.WSServerURI,Client.WSServerPROTO,true);
          }
        }
      }
    }
  }
  _ToggleHelp(e) { this.HelpDock.setVisible(e.detail.checked); }
  _ToggleAbout() { 
    this.HelpDialog.style.left = (parseInt(document.body.firstElementChild.offsetWidth) / 2 - parseInt(this.HelpDialog.style.width) / 2) + "px";
    this.HelpDialog.style.top = (parseInt(document.body.firstElementChild.offsetHeight) / 2 - parseInt(this.HelpDialog.style.height) / 2) + "px";
    this.HelpDialog.show();
  }
  _ToggleAll() {
    if (this.vChan.isChecked() && this.vHighlight.isChecked() && this.vNotice.isChecked() && this.vQuery.isChecked() && this.vServer.isChecked()) { var Invert = true; }
    if (!this.vChan.isChecked() || Invert) { this.vChan.toggle(); }
    if (!this.vHighlight.isChecked() || Invert) { this.vHighlight.toggle(); }
    if (!this.vNotice.isChecked() || Invert) { this.vNotice.toggle(); }
    if (!this.vQuery.isChecked() || Invert) { this.vQuery.toggle(); }
    if (!this.vServer.isChecked() || Invert) { this.vServer.toggle(); }
  }
  _ToggleFullscreen() { 
    if (document.fullscreenElement == null) { document.documentElement.requestFullscreen(); }
    else { document.exitFullscreen(); }
  }
  _ToggleChan(e) { this.MonitorChan.setVisible(e.detail.checked); }
  _ToggleHighlight(e) { this.MonitorHighlight.setVisible(e.detail.checked); }
  _ToggleMenubar(e) { this.menuBar().style.display = (e.detail.checked == true ? '' : 'none'); }
  _ToggleNotice(e) { this.MonitorNotice.setVisible(e.detail.checked); }
  _ToggleQuery(e) { this.MonitorQuery.setVisible(e.detail.checked); }
  _ToggleServer(e) { this.MonitorServer.setVisible(e.detail.checked); }
  _ToggleStatus(e) { this._StatusBar.style.display = (e.detail.checked == true ? '' : 'none'); }
  _ToggleToolbar(e) { this.Toolbar.setVisible(e.detail.checked); }
  _ToggleTreebar(e) { this.TreeDock.setVisible(e.detail.checked); }

  _Color(type,bool) { return (isNaN(this._Config['colors'][type]) ? this._Config['colors'][type] : (bool ? this._Config['colors'][type] : this._Config['palette'][this._Config['colors'][type]])); }

  _NewSession(Nick,Server,Protocol,AutoJoin) {
    var x = 1;
    Object.keys(this.Sessions).forEach((target) => { if ("" + x + "" == target) { x++; } });
    this.Sessions[x] = {
      Client: new IRCClient(x,Nick,Server),
      Windows: { "status window": new CustomWindow(this.MDI,{root:this,type:'status',cid:x,target:'status window',title:'Status: Not Connected'}) } 
    };
    
    this.Sessions[x].Client.addListener('action',this,this.onAction);
    this.Sessions[x].Client.addListener('connect',this,this.onConnect);
    this.Sessions[x].Client.addListener('ctcp',this,this.onCtcp);
    this.Sessions[x].Client.addListener('ctcpreply',this,this.onCtcpReply);
    this.Sessions[x].Client.addListener('disconnect',this,this.onDisconnect);
    this.Sessions[x].Client.addListener('invite',this,this.onInvite);
    this.Sessions[x].Client.addListener('join',this,this.onJoin);
    this.Sessions[x].Client.addListener('kick',this,this.onKick);
    this.Sessions[x].Client.addListener('logon',this,this.onLogon);
    this.Sessions[x].Client.addListener('mode',this,this.onMode);
    this.Sessions[x].Client.addListener('nick',this,this.onNick);
    this.Sessions[x].Client.addListener('notice',this,this.onNotice);
    this.Sessions[x].Client.addListener('part',this,this.onPart);
    this.Sessions[x].Client.addListener('ping',this,this.onPing);
    this.Sessions[x].Client.addListener('pong',this,this.onPong);
    this.Sessions[x].Client.addListener('privmsg',this,this.onPrivmsg);
    this.Sessions[x].Client.addListener('tagmsg',this,this.onTagmsg);
    this.Sessions[x].Client.addListener('quit',this,this.onQuit);
    this.Sessions[x].Client.addListener('raw',this,this.onRaw);
    this.Sessions[x].Client.addListener('smode',this,this.onSmode);
    this.Sessions[x].Client.addListener('snotice',this,this.onSnotice);
    this.Sessions[x].Client.addListener('topic',this,this.onTopic);
    this.Sessions[x].Client.addListener('umode',this,this.onUmode);
    
    if (AutoJoin) { this.Sessions[x].TempAutoJoin = AutoJoin; }
    if (/^wss?:\/\//i.test(Server)) { this.Sessions[x].Client.WSConnect(this.Sessions[x].Client.Me,Server,Protocol); }
    this._updateStatus();
    //this._ShowNotification('favicon.ico','Web-IRC','Welcome to Web-IRC!',2000);
  }
  _NewSubWindow(x,wtype,wtarget) {
    if (this.Sessions.hasOwnProperty(x)) {
      if (!this.Sessions[x].Windows.hasOwnProperty(wtarget.toLowerCase())) {
        this.Sessions[x].Windows[wtarget.toLowerCase()] = new CustomWindow(this.MDI,{root:this,owner:this.Sessions[x].Windows['status window'],type:wtype,cid:x,target:wtarget});    
      }
      else { this.MDI.setActiveSubWindow(this.Sessions[x].Windows[wtarget.toLowerCase()]); }
    }
  }
  _CloseSession(cid) {
    if (this.Sessions.hasOwnProperty(cid)) {
      var close = window.confirm("Are you sure you wish to close this session and all subsequent windows?")
      if (close) {
        if (this.Sessions[cid].hasOwnProperty('Windows')) {
          Object.keys(this.Sessions[cid].Windows).reduceRight((_, key) => {
            if (this.Sessions[cid].Windows[key].TreeItem.parentNode) { this.Sessions[cid].Windows[key].TreeItem.parentNode.removeChild(this.Sessions[cid].Windows[key].TreeItem); }
            if (this.Sessions[cid].Windows[key].parentNode) { this.Sessions[cid].Windows[key].parentNode.removeChild(this.Sessions[cid].Windows[key]); }
            if (this.Sessions[cid].Windows[key]._Type == 'status') { clearInterval(this.Sessions[cid].Windows[key].OnlineTimer); }
            delete this.Sessions[cid].Windows[key];
          }, null);
        }
        this.Sessions[cid].Client.WSClose();
        delete this.Sessions[cid];
      }
    }
  }
  _CloseSubWindow(cid,target) {
    if (this.Sessions.hasOwnProperty(cid)) {
      if (this.Sessions[cid].hasOwnProperty('Windows')) {
        Object.keys(this.Sessions[cid].Windows).reduceRight((_, key) => {
          if (this.Sessions[cid].Windows[key] == target) {
            if (this.Sessions[cid].Windows[key].TreeItem.parentNode) { this.Sessions[cid].Windows[key].TreeItem.parentNode.removeChild(this.Sessions[cid].Windows[key].TreeItem); }
            if (this.Sessions[cid].Windows[key].parentNode) { this.Sessions[cid].Windows[key].parentNode.removeChild(this.Sessions[cid].Windows[key]); }
            delete this.Sessions[cid].Windows[key];
          }
        }, null);
      }
    }
  }
  _updateStatus() {
    var active = this.MDI.activeSubWindow();
    if (active && active.hasOwnProperty('_Cid')) { 
      var Client = this.Sessions[active._Cid].Client;
      if (Client.Socket && Client.Socket.readyState == 1) { this._StatusBar.innerText = Client.Me + " [+" + Client.UMode + "] on " + Client.Server + (Client.Latency != "" && !isNaN(Client.Latency) ? " Latency: " + Client.Latency + " ms" : ""); }
      else { this._StatusBar.innerText = Client.Me + " (Not Connected)"; }
    }
    else { console.log("status error:"); console.log(active); }
  }
  async _ShowNotification(icon,title,body,N) {
    var granted = false;

    if (Notification.permission === 'granted') { granted = true; } 
    else if (Notification.permission !== 'denied') {
      var permission = await Notification.requestPermission();
      granted = permission === 'granted' ? true : false;
    }
    if (granted) {
      var notification = new Notification(title,{'icon': icon, 'body': body});
      setTimeout(() => { notification.close(); },(N || 5000));
    }
  }
  _stringify(IRCv3) {
    var ret = [];
    Object.keys(IRCv3).forEach((key) => {
      if (key != 'clientonly') {
        ret.push(key + "=" + IRCv3[key].replace(/([\x3B\x5C \r\n])/g,(m) => { 
          if (m == "\x3B") { return "\x5C:"; }
          if (m == "\x5C") { return "\x5C\x5C"; }
          if (m == " ") { return "\x5Cs"; }
          if (m == "\r") { return "\x5Cr"; }
          if (m == "\n") { return "\x5Cn"; }
        }));
      }
    });
    if (IRCv3.hasOwnProperty('clientonly')) {
      Object.keys(IRCv3.clientonly).forEach((key) => {
        ret.push("+" + key + "=" + IRCv3.clientonly[key].replace(/([\x3B\x5C \r\n])/g,(m) => { 
          if (m == "\x3B") { return "\x5C:"; }
          if (m == "\x5C") { return "\x5C\x5C"; }
          if (m == " ") { return "\x5Cs"; }
          if (m == "\r") { return "\x5Cr"; }
          if (m == "\n") { return "\x5Cn"; }
        }));
      });
    }
    return "@" + ret.join(";") + " ";
  }

  _SendData(Client,Data,IRCv3) {
    var Tags = "";
    //RFC 2812 Max line length = 512 (510 cause of the \r\n for the end of line)
    var RFCLen = 358; //512-(:(1)+NICKLEN(70)+!(1)+USERLEN(15)+@(1)+HOSTLEN(64)+\r\n(2))
    if (Client.IrcV3Cap.includes('message-tags') && IRCv3) { Tags = this._stringify(IRCv3); }

    if (Client.hasOwnProperty('Socket') && Client.Socket.readyState == 1) {
      //Break up channel joins via reported ModeSpl
      if (/^JOIN/i.test(Data) && Data.indexOf(',') > -1) {
        var chans = Data.substr(5) , match;
        var exp = new RegExp("((?:[^\x2c]+\x2c?){1," + Client.ModeSpl + "})","g");
        while (match = exp.exec(chans)) {
          var split = match[0];
          if (split.substr(split.length -1) == ',') { split = split.substr(0,split.length -1); }
          Client.WSSend(Tags + "JOIN " + split);
        }
      }
      //Fix too-long privmsg's
      else if (/^PRIVMSG/i.test(Data) && Data.length > RFCLen) {
        RFCLen -= Data.substr(0,Data.indexOf(':') + 1).length; //Include "PRIVMSG <target> :" length (gotta prune to what a server relays... UGH...)
        var cmd = Data.substr(0,Data.indexOf(':') + 1);
        Data = Data.substr(cmd.length);
        while (Data.length > RFCLen) {
          var tmp = Data.substr(0,RFCLen) , wbreak = (tmp.lastIndexOf(" ") == -1 ? RFCLen : tmp.lastIndexOf(" "));
          Client.WSSend(cmd + Data.substr(0,wbreak));
          Data = Data.substr(wbreak);
        }
        if (Data) { Client.WSSend(Tags + cmd + Data); }
      }
      else { Client.WSSend(Tags + Data); }
    }
    else { this._Echo(Client.CID,"status window",1,'#FF0000'," * Error: not connected!"); }
  }
  _Echo(cid,target,highlight,color,line) {
    if (this.Sessions.hasOwnProperty(cid) && this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) {
      var Stamp = (this._Config['options']['irc'].timestamp ? AscTime(new Date(),this._Config['options']['irc'].timestampformat) + " " : "");
      this.Sessions[cid].Windows[target.toLowerCase()]._echo(highlight,color,Stamp + line);
      
      if (this.Sessions[cid].Windows[target.toLowerCase()]._Type == "status") {
        this.Sessions[cid].Windows['status window']._updateTitle();
        var Client = this.Sessions[cid].Client;
        this._MonitorEcho(this.MonitorServerViewPort,color,(Client.Network != "" ? Client.Network : Client.Server) + ": " + line)
      }
    }
    //else { console.log('Error: ' + cid + " has no window: " + target); }
  }
  _embedFragment(target) {
    if (target.hasOwnProperty('_DocumentFragment')) {
      var shouldscroll = ((target.scrollTop + target.clientHeight) == target.scrollHeight ? true : false);
      target.appendChild(target._DocumentFragment);
      delete target._DocumentFragment;
      if (shouldscroll) { setTimeout(() => { target.scrollTop = target.scrollHeight; }); }
    }
  }
  _MonitorEcho(target,color,string) {
    if (target.childNodes.length == this._Config['windows'].buffer) { target.removeChild(target.firstElementChild); }
    var Stamp = (this._Config['options']['irc'].timestamp ? AscTime(new Date(),this._Config['options']['irc'].timestampformat) + " " : "");
    if (!target.hasOwnProperty('_DocumentFragment')) { target._DocumentFragment = document.createDocumentFragment(); }
    target._DocumentFragment.appendChild(QuickElement('span',{style:'color:' + color},this.CC2Html(Stamp + string + "\n").replace(/((?:https?|ftp):\/\/(?:[\w_-]+(?:(?:\.[\w_-]+)+))(?:[\w.,@?^=%&:/~+#-;]*[\w@?^=%&/~+#-])?)/ig,function(match,url) { return '<a href="' + url + '" target="_blank">' + url + '</a>'; })));
    window.requestAnimationFrame(() => { this._embedFragment(target); });
  }
  _processInputLine(Sender,line,ctrlKey) {
    var Client = this.Sessions[Sender._Cid].Client;
	  if (!ctrlKey && line.match(/^(\x2f+[^ ]+) ?((?: ?[+-][^-+ ]+(?: [^ ]+)?)*) ?(.*)$/)) {
      var Cmd = RegExp.$1 , Flags = RegExp.$2, Extra = RegExp.$3 || '';
      //console.log('CMD: ' + Cmd + ' F: ' + Flags + ' Extra: ' + Extra);
        
      //Single Tier Cmds (No Flags)
      if (/^\x2f+serverargs$/i.test(Cmd)) {
        console.log(Client.ServerARGS);
      }
     else if (/^\x2f+ame$/i.test(Cmd)) {
        Object.keys(this.Sessions[Sender._Cid].Windows).forEach((win) => { 
          if (Client.isChan(win)) {
            Sender._Root._SendData(Client,'PRIVMSG ' + win + ' :ACTION ' + Extra + ''); 
            Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + win + ' :ACTION ' + Extra + '');
          }
        }); 
      }
      else if (/^\x2f+amsg$/i.test(Cmd)) {
        Object.keys(this.Sessions[Sender._Cid].Windows).forEach((win) => { 
          if (Client.isChan(win)) {
            Sender._Root._SendData(Client,'PRIVMSG ' + win + ' :' + Extra);
            Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + win + ' :' + Extra);
          }
        }); 
      }
      else if (/^\x2f+away$/i.test(Cmd)) { Sender._Root._SendData(Client,'AWAY' + (Extra != "" ? " :" + Extra : "")); }
      //else if (/^\x2f+beep$/i.test(Cmd)) { this._InternalBeep(); }
      //else if (/^\x2f+channel$/i.test(Cmd)) { } /* GUI Chan Central */
      else if (/^\x2f+ctcp$/i.test(Cmd)) { if (/^([^ ]+) ([^ ]+)(.*)/.test(Extra)) { Sender._Root._SendData(Client,'PRIVMSG ' + RegExp.$1 + " :" + RegExp.$2 + RegExp.$3 + ""); } }
      else if (/^\x2f+connect$/i.test(Cmd)) { 
        if (Client.WSServerURI && Client.WSServerPROTO) {
          if (Client.hasOwnProperty('Socket') && Client.Socket.readyState == 3) {
            Client.ConnectRetry = 1;
            Client.WSConnect(Client.Me,Client.WSServerURI,Client.WSServerPROTO,true);
          }
        }
      }
      else if (/^\x2f+ctcpreply$/i.test(Cmd)) { if (/^([^ ]+) ([^ ]+)(.*)/.test(Extra)) { Sender._Root._SendData(Client,'NOTICE ' + RegExp.$1 + " :" + RegExp.$2 + RegExp.$3 + ""); } }
      else if (/^\x2f+debug$/i.test(Cmd)) { Client.Debug = (/^on$/i.test(Extra) ? true : false ); }
      else if (/^\x2f+disconnect$/i.test(Cmd)) { Client.WSClose(); }
      else if (/^\x2f+ebeeps$/i.test(Cmd)) {
        var onoff = (/^on$/i.test(Extra) ? true : false );
        this._Config['options']['irc'].ebeeps = onoff;
        this._Echo(Client.CID,"status window",1,this._Color('info'),"* Event Beeps are " + (onoff ? "on" : "off"));
      }

      else if (/^\x2f+help$/i.test(Cmd)) { this._ToggleHelp({detail:{checked: true}}); }
      //else if (/^\x2f+invite$/i.test(Cmd)) { } /* Should be built in on an irc server? */
      else if (/^\x2f+kick$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ([^ ]+) ?(.*)$/)) { Sender._Root._SendData(Client,'KICK ' + RegExp.$1 + '' + RegExp.$2 + ' :' + RegExp.$3); } }
      //else if (/^\x2f+links$/i.test(Cmd)) { } /* GUI Server Links */
      //else if (/^\x2f+list$/i.test(Cmd)) { } /* GUI Channels List */
      else if (/^\x2f+(?:priv)?msg$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ?(.*)$/)) { Sender._Root._SendData(Client,'PRIVMSG ' + RegExp.$1 + ' :' + RegExp.$2); } }
      else if (/^\x2f+menubar$/i.test(Cmd)) { this._ToggleMenubar({detail:{checked: (/^on$/i.test(Extra) ? true : false )}}); }
      else if (/^\x2f+notice$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ?(.*)$/)) { Sender._Root._SendData(Client,'NOTICE ' + RegExp.$1 + ' :' + RegExp.$2); } }
      else if (/^\x2f+part$/i.test(Cmd)) { Sender._Root._SendData(Client,'PART ' + Extra); }
      else if (/^\x2f+partall$/i.test(Cmd)) { Object.keys(this.Sessions[Sender._Cid].Windows).forEach((win) => { if (Client.isChan(win)) { Sender._Root._SendData(Client,'PART ' + win); } }); }
      else if (/^\x2f+statusbar$/i.test(Cmd)) { this._ToggleStatus({detail:{checked: (/^on$/i.test(Extra) ? true : false )}}); }
      else if (/^\x2f+toolbar$/i.test(Cmd)) { this._ToggleToolbar({detail:{checked: (/^on$/i.test(Extra) ? true : false )}}); }
      else if (/^\x2f+topic$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ?(.*)$/)) { Sender._Root._SendData(Client,'TOPIC ' + RegExp.$1 + ' :' + RegExp.$2); } }
      else if (/^\x2f+treebar$/i.test(Cmd)) { this._ToggleTreebar({detail:{checked: (/^on$/i.test(Extra) ? true : false )}}); }
      else if (/^\x2f+query$/i.test(Cmd)) { 
        if (!this.Sessions[Sender._Cid].Windows.hasOwnProperty(Extra.toLowerCase())) { this._NewSubWindow(Sender._Cid,'query',Extra); }
        else { this.MDI.setActiveSubWindow(this.Sessions[Sender._Cid].Windows[Extra.toLowerCase()]); }
      }
      else if (/^\x2f+raw|quote$/i.test(Cmd)) { Sender._Root._SendData(Client,Extra); }
      //Window specific cmds
      else if (/^\x2f+me$/i.test(Cmd)) {
        if (/^(channel|query)$/i.test(Sender._Type)) { 
          Sender._Root._SendData(Client,'PRIVMSG ' + Sender._Target + ' :ACTION ' + Extra + ''); 
          if (!Client.IrcV3Cap.includes('echo-message')) { Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + Sender._Target + ' :ACTION ' + Extra + ''); }
        }
      }
      else if (/^\x2f+say$/i.test(Cmd)) { 
        if (/^(channel|query)$/i.test(Sender._Type)) { 
          Sender._Root._SendData(Client,'PRIVMSG ' + Sender._Target + ' :' + Extra); 
          if (!Client.IrcV3Cap.includes('echo-message')) { Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + Sender._Target + ' :' + Extra); }
        }
      }

      //Multi Tier Cmds (With Flags)
      //else if (/^ban$/i.test(Cmd)) { }
      else if (/^\x2f+clear$/i.test(Cmd)) { 
        if (Flags.indexOf('h') > -1) { this.MonitorHighlightViewPort.innerHTML = ""; }
        if (Flags.indexOf('c') > -1) { this.MonitorChanViewPort.innerHTML = ""; }
        if (Flags.indexOf('q') > -1) { this.MonitorQueryViewPort.innerHTML = ""; }
        if (Flags.indexOf('n') > -1) { this.MonitorNoticeViewPort.innerHTML = ""; }
        if (Flags.indexOf('s') > -1) { this.MonitorServerViewPort.innerHTML = ""; }
        if (Flags == "") { Sender.ViewPort.innerHTML = ""; }
      }
      else if (/^\x2f+clearall$/i.test(Cmd)) { 
        if (Flags == "" || Flags.indexOf('s') > -1) { Object.keys(this.Sessions).forEach((cid) => { this.Sessions[cid].Windows['status window'].ViewPort.innerHTML = ""; }); }
        if (Flags == "" || Flags.indexOf('n') > -1) { Object.keys(this.Sessions).forEach((cid) => { Object.keys(this.Sessions[cid].Windows).forEach((win) => { if (this.Sessions[cid].Windows[win]._Type == "channel") { this.Sessions[cid].Windows[win].ViewPort.innerHTML = ""; } }); }); }
        if (Flags == "" || Flags.indexOf('q') > -1) { Object.keys(this.Sessions).forEach((cid) => { Object.keys(this.Sessions[cid].Windows).forEach((win) => { if (this.Sessions[cid].Windows[win]._Type == "query") { this.Sessions[cid].Windows[win].ViewPort.innerHTML = ""; } }); }); }
        if (Flags == "" || Flags.indexOf('a') > -1) { Object.keys(this.Sessions).forEach((cid) => { Object.keys(this.Sessions[cid].Windows).forEach((win) => { this.Sessions[cid].Windows[win].ViewPort.innerHTML = ""; }); }); }
        if (Flags == "" || Flags.indexOf('m') > -1) { this.MonitorChanViewPort.innerHTML = this.MonitorHighlightViewPort.innerHTML = this.MonitorNoticeViewPort.innerHTML = this.MonitorQueryViewPort.innerHTML = this.MonitorServerViewPort.innerHTML = ""; }
      }
      //else if (/^\x2f+close$/i.test(Cmd)) { }
      else if (/^\x2f+echo$/i.test(Cmd)) {
        var target;
        if (/-a ([^ ]+)/i.test(Flags)) { target = Sender._Target; Extra = RegExp.$1 + " " + Extra; }
        else if (/-s ([^ ]+)/i.test(Flags)) { target = "status window"; Extra = RegExp.$1 + " " + Extra; }
        else {
          var Args = Extra.split(/\s+/g);
          target = Args[0]; 
          Extra = Args.slice(1).join(" "); 
        }
        this._Echo(Sender._Cid,target,0,'inherit',Extra);
      }
      else if (/^\x2f+join$/i.test(Cmd)) { 
        if (!this.Sessions[Sender._Cid].Windows.hasOwnProperty(Extra.toLowerCase())) { Sender._Root._SendData(Client,'JOIN ' + Extra); }
        else { 
          if (this.Sessions[Sender._Cid].Windows[Extra.toLowerCase()].List.Children().length == 0) { Sender._Root._SendData(Client,'JOIN ' + Extra); }
          this.MDI.setActiveSubWindow(this.Sessions[Sender._Cid].Windows[Extra.toLowerCase()]); 
        }
      }
      else if (/^\x2f+server$/i.test(Cmd)) {
        var Nick = Client.Me , Server = Extra , NS = false, AJ , Proto = ['text.ircv3.net'];
        if (Flags.indexOf(' ') > -1) {
          if (/-[mn] ([^ ]+)/i.test(Flags)) { Server = RegExp.$1; NS = true; }
          if (/-i ([^ ]+)/i.test(Flags)) { Nick = RegExp.$1; }
          if (/-j ([^ ]+)/i.test(Flags)) { AJ = RegExp.$1; }
          if (/-p ([^ ]+)/i.test(Flags)) { Proto[0] = RegExp.$1; }
        }
        else if (Flags.indexOf('n') > -1) { this._NewSession(Nick,'',Proto); }
        if (NS == true) { this._NewSession(Nick,Server,Proto,AJ); }
        else if (/^wss?:\/\//i.test(Server)) { 
          this.Sessions[Sender._Cid].TempAutoJoin = AJ;
          Client.WSConnect(Nick,Server,Proto); 
        }
      }
      else { Sender._Root._SendData(Client,Cmd.substr(1) + ' ' + Extra); }
    }
    else if (line != "") { 
      if (/^(channel|query)$/i.test(Sender._Type)) {
        Sender._Root._SendData(Client,'PRIVMSG ' + Sender._Target + " :" + line); 
        if (!Client.IrcV3Cap.includes('echo-message')) { Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + Sender._Target + " :" + line); }
      }
      else { this._Echo(Client.CID,"status window",1,'#FF0000'," * Error: no command specified!"); }
    }
    if (line != "") {
      Sender._EditBoxHistory.push(line);
      if (Sender._TypeObject.hasOwnProperty(Client.Me)) { delete Sender._TypeObject[Client.Me]; }
      Sender._updateTypers(true);
      Sender.EditBox.value = '';
      Sender.EditBox.dataset.hindex = Sender._EditBoxHistory.length;
    }
  }
  _handleInput(Sender,e) { 
    var key = e.keyCode || e.charCode;
    //handle enter in editbox (send)
    if (key == 13 || key == 10) { Sender._Root._processInputLine(Sender,Sender.EditBox.value,e.ctrlKey); Sender.EditBox.dataset.typing = ''; }

    //handle editbox history (up/dn arrows)
    else if (key == 38 || key == 40) {
      var dir = key - 39 , LastHistory = parseInt(Sender.EditBox.dataset.hindex) , hindex = LastHistory + dir;
      if (Sender._EditBoxHistory.length > 0 && hindex < Sender._EditBoxHistory.length) {
        if (hindex >= 0) { 
          Sender.EditBox.value = Sender._EditBoxHistory[hindex]; 
          Sender.EditBox.dataset.hindex = hindex;
        }
        setTimeout(() => { Sender.EditBox.selectionStart = Sender.EditBox.selectionEnd = (Sender.EditBox.value).length + 1; });
      }
      else if (hindex >= 0) { Sender.EditBox.value = ''; }
    }

    //handle ctrl+key shortcuts (control codes stuffs... Ctrl+BURKIEDQO)
    else if (e.ctrlKey) {
      var codes = [66,85,82,75,73,69,68,81,79] , chars = {'66':"",'85':"",'82':"",'75':"",'73':"",'69':"",'68':"",'81':"",'79':""};
      if (codes.indexOf(key) > -1) {
        e.preventDefault(); 
        e.stopPropagation();
     
        if (Sender.EditBox.selectionStart || Sender.EditBox.selectionStart == '0') {
          var startPos = Sender.EditBox.selectionStart , endPos = Sender.EditBox.selectionEnd;
          Sender.EditBox.value = Sender.EditBox.value.substring(0, startPos) + chars[key] + Sender.EditBox.value.substring(endPos, Sender.EditBox.value.length); 
          Sender.EditBox.selectionStart = startPos + 1; 
          Sender.EditBox.selectionEnd = startPos + 1;
        }
        else { Sender.EditBox.value += chars[key]; }
      }
    }

    //tab completion 
    else if (!e.ctrlKey && !e.shiftKey && key == 9) {
      e.preventDefault();
      var Client = this.Sessions[Sender._Cid].Client;
      var ReTab = parseInt(Sender.EditBox.dataset.tabcomp) || Sender.EditBox.selectionStart;
      var preText = Sender.EditBox.value.substring(0,ReTab) , postText = Sender.EditBox.value.substring(Sender.EditBox.selectionStart);
      var word = preText.split(/\s+/g).pop();
      if (word) {
        var toExp = word.replace(/(.)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16));
        var exp = new RegExp("^(?:[" + Client.Prefix.replace(/(.)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16)) + "]+)?(" + word.replace(/(.)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16)) + ".*)","i");
        var chanexp = new RegExp("^[" + Client.ChanTypes.replace(/(.)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16)) + "]","i");
        var Matches = [];
        if (chanexp.test(word)) { 
          if (exp.test(Sender._Target)) { Matches.push(RegExp.$1); }
          Object.keys(this.Sessions[Sender._Cid].Windows).forEach((key) => { if (Sender._Target.toLowerCase() != key && exp.test(this.Sessions[Sender._Cid].Windows[key]._Target)) { Matches.push(RegExp.$1); } });
        }
        else if (/^\x2f/i.test(word)) {
          var cmds = ['/ame','/amsg','/away','/beep','/channel','/clear','/clearall','/ctcp','/ctcpreply','/disconnect','/ebeeps','/help','/invite','/join','/kick','/links','/list','/me','/msg','/menubar','/part','/partall','/privmsg','/say','/server','/statusbar','/toolbar','/topic','/treebar','/query','/quote','/raw'];
          var pexp = new RegExp("^(" + word.replace(/(.)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16)) + ".*)","i");
          cmds.forEach((cmd) => { if (pexp.test(cmd)) { Matches.push(RegExp.$1); } });
        }
        else if (Sender.hasOwnProperty('List')) { Sender.List.Children().forEach((elem) => { if (exp.test(elem.innerText)) { Matches.push(RegExp.$1); } }); }
        if (Matches.length > 0) {
          var LastIndex = parseInt(Sender.EditBox.dataset.lastindex);
          if (isNaN(LastIndex) || LastIndex == (Matches.length - 1)) { LastIndex = -1; }
          LastIndex++;
          Sender.EditBox.value = preText.substr(0,preText.length - word.length) + Matches[LastIndex] + postText;
          Sender.EditBox.selectionStart = preText.length - word.length + Matches[LastIndex].length; 
          Sender.EditBox.selectionEnd = preText.length - word.length + Matches[LastIndex].length;
          Sender.EditBox.dataset.tabcomp = ReTab;
          Sender.EditBox.dataset.lastindex = LastIndex;
        }
      }
    }
    //clear tabcomp data and history scroll data on any keypress that isn't chr9
    else { 
      Sender.EditBox.dataset.tabcomp = Sender.EditBox.dataset.lastindex = ''; Sender.EditBox.dataset.hindex = Sender._EditBoxHistory.length; 
      //IRCv3 Client-Only typing support... Advertise your typing!
      var Client = this.Sessions[Sender._Cid].Client
      if ((!Sender.EditBox.dataset.typing || (Date.now() - Sender.EditBox.dataset.typing) >= 3000) && (/^(channel|query)$/i.test(Sender._Type) && Client.IrcV3Cap.includes('message-tags'))) { 
        var firstchr = Sender.EditBox.value.substr(0,1);
        if (firstchr || key == 8) {
          if (firstchr == "/" || key == 191) { return; }
          this._SendData(Client,"TAGMSG " + Sender._Target,{clientonly: { typing: ((Sender.EditBox.value.length > 1 || key != 8) ? "active" : "done") }}); 
          Sender.EditBox.dataset.typing = Date.now();
        }
      }
    }
  }
  _updateWindowTypers(Win,nick,ircv3) {
    if (ircv3.clientonly.hasOwnProperty('typing')) {
      if (ircv3.clientonly.typing != "done") { Win._TypeObject[nick] = Date.now(); }
      else if (Win._TypeObject.hasOwnProperty(nick)) { delete Win._TypeObject[nick]; }
      Win._updateTypers();
    }
  }

  CC2Html(text) {
    // === CC var is a direct rip of $rgb($color(N)) converted to base 16. N is 0-99 for all 100 new colors added to mIRC.
    var cc = this._Config['palette'];
    var b = 0, u = 0, r = 0 , i = 0, s = 0, m = 0, bg = cc.length, fg = cc.length;

    return text.replace(/([&<>])/g,(m,e) => { return "&#" + e.charCodeAt(0) + ";"; }).replace(/(\x03(?:(?:\d\d?),)?(?:\d\d?)|[\x04\ufffd](?:(?:[0-9A-Fa-f]{6}),)?(?:[0-9A-Fa-f]{6})|[\x02\x03\x04\ufffd\x11\x16\x1d\x1e\x0f\x1f])([^\x02\x03\x04\ufffd\x11\x16\x1d\x1e\x0f\x1f]*)/gu,function(match,control,string) {
      if (control == '\x03') { fg = bg = cc.length; } //Blank ctrl+k
      else if (control == '\x02') { b = !b } //ctrl+b (bold)
      else if (control == '\x1f') { u = !u }  //ctrl+u (underline)
      else if (control == '\x16') { var tmp = bg; bg = fg; fg = tmp; }  //ctrl+r (reverse)
      else if (control == '\x1d') { i = !i } //ctrl+i (italic)
      else if (control == '\x1e') { s = !s } //ctrl+e (strikethru)
      else if (control == '\x11') { m = !m } //ctrl+q (monospace)
      else if (control == '\x0f') { b = u = r = i = s = m = 0; fg = bg = cc.length; } //ctrl+o (stop all control codes)
      else if (/^\x03/.test(control)) { //ctrl+k (color)
        var fgt = /^\x03(\d\d?)$/.exec(control), bt = /^\x03(\d\d?),(\d\d?)$/.exec(control);
        if (Array.isArray(fgt) && fgt.length > 0) { fg = parseInt(fgt[1]) + 0; }
        else if (Array.isArray(bt) && bt.length > 0) { fg = parseInt(bt[1]) + 0; bg = parseInt(bt[2]) + 0; }
      }
      else if (/^(?:\x04|\ufffd)/u.test(control)) { //ctrl+? (color RGB-hex) TODO: remove \ufffd <?> replacement char. Websockets see this instead of \x04
        var fgt = /^[\x04\ufffd]([0-9A-Fa-f]{6})$/.exec(control), bt = /^[\x04\ufffd]([0-9A-Fa-f]{6}),([0-9A-Fa-f]{6})$/.exec(control);
        if (Array.isArray(fgt) && fgt.length > 0) { fg = fgt[1]; }
        else if (Array.isArray(bt) && bt.length > 0) { fg = bt[1]; bg = bt[2]; }
      }

      var style =  (b ? 'font-weight:bold;' : '') + (u ? 'text-decoration:underline;' : (s ? 'text-decoration:line-through;' : '')) + (i ? 'font-style:italic;' : '') + (m ? 'font-family:monospace;' : '') + (bg < cc.length || (bg && isNaN(bg)) ? 'background-color:' + (isNaN(bg) ? "#" + bg : cc[bg]) + ';' : '') + (fg < cc.length  || fg.length == 6 ? 'color:' + (fg.length == 6 ? "#" + fg : cc[fg]) + ';' : '');
      if (!style) { return string; }
      else { return "<span style=\"" + style + "\">" + string + "</span>"; }
    });
    //return "<span style=\"color:" + (isNaN(linecolor) ? linecolor : cc[linecolor]) + "\">" + ret + "</span>";
  }

  onAction(cid,nick,address,target,msg,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('action');
    if (Client.isChan(target)) {
      var IAL = Client.GetIAL(nick) , Line = "* " + (IAL && this._Config['options']['irc'].showprefix ? IAL.channels[target.toLowerCase()].substr(0,1) : "") + nick + " " + msg;
      if (nick != Client.Me) {
        var toExp = Client.Me.replace(/(\W)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16));
        var exp = new RegExp("\\b" + toExp + "\\b","i");
        if (exp.test(msg)) { 
          LineColor = this._Color('highlight'); 
          this._MonitorEcho(this.MonitorHighlightViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
        }
      }

      ircv3.clientonly.typing = "done";
      this._updateWindowTypers(this.Sessions[cid].Windows[target.toLowerCase()],nick,ircv3);
      this._Echo(cid,target,2,LineColor,Line);
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
    }
    else {
      var Line = "* " + nick + "  " + msg; 
      if (nick == Client.Me) {
        if (!this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this._NewSubWindow(cid,'query',target); }
        this._Echo(cid,target,2,LineColor,Line);
      }
      else {
        if (!this.Sessions[cid].Windows.hasOwnProperty(nick.toLowerCase())) { this._NewSubWindow(cid,'query',nick); }
        var toExp = Client.Me.replace(/(\W)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16));
        var exp = new RegExp("\\b" + toExp + "\\b","i");
        if (exp.test(msg)) { 
          LineColor = this._Color('highlight'); 
          this._MonitorEcho(this.MonitorHighlightViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - Query: " + Line);
        }

        ircv3.clientonly.typing = "done";
        this._updateWindowTypers(this.Sessions[cid].Windows[nick.toLowerCase()],nick,ircv3);
        this._Echo(cid,nick,2,LineColor,Line);
        this._MonitorEcho(this.MonitorQueryViewPort,'inherit',(Client.Network != "" ? Client.Network : Client.Server) + ": " + Line);
      }
    }
  }
  onConnect(cid,socketState) {
    var Client = this.Sessions[cid].Client , LineColor = this._Color('info') , rejoin = [];
    this._ToggleConnection(true);
    if (socketState == 0) { 
      if (Client.hasOwnProperty('ConnectRetry')) { this._Echo(cid,"status window",1,LineColor,"* Connect retry(" + Client.ConnectRetry + "): " + Client.WSServerURI); }
      else { this._Echo(cid,"status window",1,LineColor,"* Connecting to " + Client.Server); }
    }
    else if (socketState == 1) {
      Client.ConnectRetry = 1;
      var AutoJoin = this.Sessions[cid].TempAutoJoin;
      if (this._Config['options']['irc'].connectrejoin) {
        Object.keys(this.Sessions[cid].Windows).forEach((win) => {
          if (this.Sessions[cid].Windows[win]._Type == "channel") {
            if (this.Sessions[cid].Windows[win].List.Children().length == 0) { rejoin.push(this.Sessions[cid].Windows[win]._Target); }
          }
        });
        if (rejoin.length > 0) { this._SendData(Client,"JOIN " + rejoin.join(",")); }
        else if (AutoJoin && AutoJoin != '') { this._SendData(Client,"JOIN " + AutoJoin); }
        delete this.Sessions[cid].TempAutoJoin;
      }
    }
  }
  onCtcp(cid,nick,address,target,msg,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('ctcp');
    var win = "status window";
    if (Client.isChan(target)) { win = target; }
    this._Echo(cid,win,2,LineColor,"[" + nick + " " + msg + "]");
  }
  //TODO: Fix ctcp reply (remove Args)
  onCtcpReply(cid,nick,address,target,msg,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('ctcp');
    var win = "status window";
    if (Client.isChan(target)) { win = target; }
    this._Echo(cid,win,2,LineColor,"[" + nick + (Client.isChan(target) ? ":" + target : "") + " " + Args[0] + " reply]: " + Args.slice(1).join(" "));
  }
  onLogon(cid) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('info');
    if (Client.ConnectRetry) { delete Client.ConnectRetry; }
  }
  onDisconnect(cid,msg) {
    this._ToggleConnection(true);
    if (this.Sessions.hasOwnProperty(cid)) {
      var Client = this.Sessions[cid].Client , LineColor = this._Color('info');
      this._Echo(cid,"status window",1,LineColor,"* Disconnected " + (msg ?  '('  + msg + ')' : ''));
      Object.keys(this.Sessions[cid].Windows).forEach((win) => {
        if (this.Sessions[cid].Windows[win]._Type == "channel") {
          if (this.Sessions[cid].Windows[win].List.Children().length) { 
            this._Echo(cid,this.Sessions[cid].Windows[win]._Target,1,LineColor,"* Disconnected");
            this.Sessions[cid].Windows[win].List._CentralWidget.innerHTML = "";
          }
        }
      });
      if (this._Config['options']['irc'].reconnect && Client.WSServerURI && !Client.WSForceClose) {
        if (Client.ConnectRetry) { Client.ConnectRetry++; }
        else { Client.ConnectRetry = 1; }
        //TODO: Remove hard-coded retry attempts
        if (Client.ConnectRetry <= 3) { Client.WSConnect(Client.Me,Client.WSServerURI,Client.WSServerPROTO,true); }
        else {
          Client.ConnectRetry--;
          this._Echo(cid,"status window",1,LineColor,"* Connect aborted: retry limit of " + Client.ConnectRetry + " reached.");
          delete Client.ConnectRetry;
        }
      }
    }
  }
  onInvite(cid,nick,address,target,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('invite');
    this._Echo(cid,"status window",1,LineColor,"* " + nick + " invites you to: " + target);
  }
  onJoin(cid,nick,address,target,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('join');
    if (nick == Client.Me && !this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { 
      this._NewSubWindow(cid,'channel',target); 
      this.Sessions[cid].Windows[target.toLowerCase()]._BlockNAMES = true;
      this.Sessions[cid].Windows[target.toLowerCase()]._BlockWHO = true;
    }
    else if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Sessions[cid].Windows[target.toLowerCase()]._handleNickListEvent('join',nick); }
    var Line = "* Joins: " + nick + " (" + address + ")";
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onKick(cid,nick,address,target,knick,msg,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('kick');
    if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { 
      var win = this.Sessions[cid].Windows[target.toLowerCase()];
      win._handleNickListEvent('kick',knick); 
      if (knick == Client.Me) {
        if (this._Config['options']['irc'].keepchanopen) { 
          if (win.List.Children().length) { win.List._CentralWidget.innerHTML = ""; }
        }
        else { win._customEvent('childEvent',{ bubbles: true, detail: { target: this, jsEvent: null, 'QEvent': QEvent.Close } }); }
        if (this._Config['options']['irc'].kickrejoin) { this._SendData(Client,"JOIN " + win._Target); }
      }
    }
    var Line = "* " + knick + " was kicked by: " + nick + " (" + msg + ")";
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onMode(cid,nick,address,target,modes,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('mode');
    if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Sessions[cid].Windows[target.toLowerCase()]._handleNickListEvent('mode',modes); }
    var Line = "* " + nick + " sets mode: " + modes;
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onNick(cid,nick,address,newnick,ircv3) { 
    var Client = this.Sessions[cid].Client , IAL = Client.GetIAL(newnick) , LineColor = this._Color('nick');
    if (IAL) {
      if (this.Sessions[cid].Windows.hasOwnProperty(nick.toLowerCase())) {
        var win = this.Sessions[cid].Windows[nick.toLowerCase()];
        this.Sessions[cid].Windows[newnick.toLowerCase()] = win;
        win._Target = newnick;
        win.TreeItem.setText(newnick);
        win._updateTitle();
        delete this.Sessions[cid].Windows[nick.toLowerCase()];
      }
      var Line = "* " + nick + " is now known as " + newnick;
      Object.keys(IAL.channels).forEach((target) => { 
        if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Sessions[cid].Windows[target.toLowerCase()]._handleNickListEvent('nick',nick,newnick); }
        this._Echo(cid,target,1,LineColor,Line);
      });
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + Object.keys(IAL.channels).join(",") + ": " + Line);
    }
    if (newnick == Client.Me) { 
      this._Echo(cid,"status window",1,LineColor,"* You are now known as " + newnick); 
      this.Sessions[cid].Windows['status window']._updateTitle();
      this._updateStatus();
    }
  }
  onNotice(cid,nick,address,target,msg,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('notice');
    var win = "status window";
    if (Client.isChan(target)) { win = target; }
    var Line = "-" + nick + (Client.isChan(target) ? ":" + target : "") + "- " + msg;
    this._Echo(cid,win,2,LineColor,Line);
    this._MonitorEcho(this.MonitorNoticeViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + (Client.isChan(target) ? " - " + target : "") + ": " + Line);
  }
  onPart(cid,nick,address,target,msg,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('part');
    if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { 
      this.Sessions[cid].Windows[target.toLowerCase()]._handleNickListEvent('part',nick); 
      if (nick == Client.Me) { this.Sessions[cid].Windows[target.toLowerCase()]._customEvent('childEvent',{ bubbles: true, detail: { target: this, jsEvent: null, 'QEvent': QEvent.Close } }); }
    }
    var Line = "* Parts: " + nick + " (" + address + ")" + (msg ? " (" + msg + ")" : "");
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onPing(cid,msg,ircv3) { 
    var Client = this.Sessions[cid].Client;
  }
  onPong(cid,msg,ircv3) { 
    var Client = this.Sessions[cid].Client;
    this._updateStatus();
  }
  onQuit(cid,nick,address,msg,ircv3) { 
    var Client = this.Sessions[cid].Client, IAL = Client.GetIAL(nick) , LineColor = this._Color('quit');
    if (IAL) {
      var Line = "* Quits: " + nick + " (" + address + ") (" + msg + ")";
      Object.keys(IAL.channels).forEach((target) => {
        if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Sessions[cid].Windows[target.toLowerCase()]._handleNickListEvent('quit',nick); }
        this._Echo(cid,target,1,LineColor,Line);
      });
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + Object.keys(IAL.channels).join(",") + ": " + Line);
    }
  }
  onPrivmsg(cid,nick,address,target,msg,ircv3) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('normal') , Event = 2;
    if (Client.isChan(target)) {
      var IAL = Client.GetIAL(nick);
      if (nick != Client.Me) { 
        var Line = "12<14" + (IAL && this._Config['options']['irc'].showprefix ? IAL.channels[target.toLowerCase()].substr(0,1) : "") + "" + nick + "12> " + msg; 
        var toExp = Client.Me.replace(/(\W)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16));
        var exp = new RegExp("\\b" + toExp + "\\b","i");
        if (exp.test(msg)) { 
          var Line = "" + this._Color('highlight',true) + "<14" + (IAL && this._Config['options']['irc'].showprefix ? IAL.channels[target.toLowerCase()].substr(0,1) : "") + "" + nick + "" + this._Color('highlight',true) + "> " + msg; 
          Event = 3;
          this._MonitorEcho(this.MonitorHighlightViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
        }
      }
      else { var Line = "9<14" + IAL.channels[target.toLowerCase()].substr(0,1) + "" + nick + "9> " + msg; LineColor = this._Color('own'); }
      ircv3.clientonly.typing = "done";
      this._updateWindowTypers(this.Sessions[cid].Windows[target.toLowerCase()],nick,ircv3);
      this._Echo(cid,target,Event,LineColor,Line);
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
    }
    else {
      if (nick == Client.Me) {
        if (!this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this._NewSubWindow(cid,'query',target); }
        var Line = "9<" + nick + "9> " + msg; 
        LineColor = this._Color('own');
        this._Echo(cid,target,2,LineColor,Line);
      }
      else {
        if (!this.Sessions[cid].Windows.hasOwnProperty(nick.toLowerCase())) { this._NewSubWindow(cid,'query',nick); }
        var Line = "12<" + nick + "12> " + msg; 
        var toExp = Client.Me.replace(/(\W)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16));
        var exp = new RegExp("\\b" + toExp + "\\b","i");        
        if (exp.test(msg)) { 
          var Line = "" + this._Color('highlight',true) + "<" + nick + "" + this._Color('highlight',true) + "> " + msg; 
          Event = 3;
          this._MonitorEcho(this.MonitorHighlightViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - Query: " + Line);
        }
        ircv3.clientonly.typing = "done";
        this._updateWindowTypers(this.Sessions[cid].Windows[nick.toLowerCase()],nick,ircv3);
        this._Echo(cid,nick,Event,LineColor,Line);
        this._MonitorEcho(this.MonitorQueryViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + ": " + Line);
      }
    }
  }
  onTagmsg(cid,nick,address,target,ircv3) {
    if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this._updateWindowTypers(this.Sessions[cid].Windows[target.toLowerCase()],nick,ircv3); }
  }
  onRaw(cid,numeric,msg,ircv3) {
    var Client = this.Sessions[cid].Client;
    var Tokens = msg.split(" ");
    if (numeric == "332") { this._Echo(cid,Tokens[1],1,this._Color('topic'),"* Topic is '" + Tokens.slice(2).join(" ") + "'"); }
    else if (numeric == "333") { this._Echo(cid,Tokens[1],1,this._Color('topic'),"* Set by " + Tokens[2] + " on " + AscTime(new Date(parseInt(Tokens[3]) * 1000),'ddd mmm dd HH:nn:ss yyyy')); }
    //Prevent these for now... caused by joining channels
    else if (numeric == "324") { this.Sessions[cid].Windows[Tokens[1].toLowerCase()]._updateTitle(); } //Channel Modes
    else if (numeric == "329") { } //Channel Created
    else if (numeric == "352") { 
      if (this.Sessions.hasOwnProperty(cid) && this.Sessions[cid].Windows.hasOwnProperty(Tokens[1].toLowerCase())) {
        if (!this.Sessions[cid].Windows[Tokens[1].toLowerCase()]._BlockWHO) {  this._Echo(cid,"status window",1,this._Color('normal'),Tokens.slice(1).join(" ")); }
      }
    } //WHO info
    else if (numeric == "315") { 
      if (this.Sessions.hasOwnProperty(cid) && this.Sessions[cid].Windows.hasOwnProperty(Tokens[1].toLowerCase())) {
        if (!this.Sessions[cid].Windows[Tokens[1].toLowerCase()]._BlockWHO) {  this._Echo(cid,"status window",1,this._Color('normal'),Tokens.slice(1).join(" ")); }
        this.Sessions[cid].Windows[Tokens[1].toLowerCase()]._BlockWHO = false;
      }
    } //End of WHO List
    else if (numeric == "353") { 
      if (this.Sessions.hasOwnProperty(cid) && this.Sessions[cid].Windows.hasOwnProperty(Tokens[2].toLowerCase())) {
        if (!this.Sessions[cid].Windows[Tokens[2].toLowerCase()]._BlockNAMES) {  this._Echo(cid,"status window",1,this._Color('normal'),Tokens.slice(2).join(" ")); }
      }
    } //Channel names
    else if (numeric == "366") { 
      if (this.Sessions.hasOwnProperty(cid) && this.Sessions[cid].Windows.hasOwnProperty(Tokens[1].toLowerCase())) {
        var UI = this.Sessions[cid].Windows[Tokens[1].toLowerCase()];
        if (!UI._BlockNAMES) {  this._Echo(cid,"status window",1,this._Color('normal'),Tokens.slice(1).join(" ")); }
        UI._BlockNAMES = false;

        UI.List._CentralWidget.innerHTML = "";
        var Chan = Client.GetICL(Tokens[1].toLowerCase());
        Chan.Nicks.forEach((nick) => { 
          var IAL = Client.GetIAL(nick) , NickAction = new QAction('',IAL.channels[Chan.channel.toLowerCase()].substr(0,1) + nick,UI.List);
          NickAction.dataset.nick = encodeURIComponent(nick);
	      });
        UI._updateTitle();
      }
    } //channel end of names
    else { this._Echo(cid,"status window",1,this._Color('normal'),(/^\d+/.test(numeric) ? "" : numeric + " ") + Tokens.slice(1).join(" ")); }
  }
  onSnotice(cid,nick,address,target,msg) {
    var Client = this.Sessions[cid].Client;
    //this._Echo(cid,target,1,'#009393',);
  }
  onSmode(cid,nick,address,target,modes) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('mode');
    if (this.Sessions[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Sessions[cid].Windows[target.toLowerCase()]._handleNickListEvent('mode',modes); }
    var Line = "* " + nick + " sets mode: " + modes;
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onTopic(cid,nick,address,target,topic) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('topic');
    var Line = "* " + nick + " changes topic to '" + topic + "'";
    this._Echo(cid,target,1,LineColor,Line);
    this.Sessions[cid].Windows[target.toLowerCase()]._updateTitle(); 
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onUmode(cid,modes) { 
    var Client = this.Sessions[cid].Client , LineColor = this._Color('mode');
    var Line = "* " + Client.Me + " set mode: " + modes;
    this._Echo(cid,"status window",1,LineColor,Line);
    this._updateStatus();
  }
}
customElements.define('web-irc', WebIRC);

class CustomWindow extends QMdiSubWindow {
  constructor(parent,Attributes) {
    super(parent);
    this._Root = Attributes.root;
    this._Type = Attributes.type;
    this._Cid = Attributes.cid;
    this._Target = Attributes.target;
    this._Highlight = 0;
    this._TypeObject = {};
    this._TypeTimer = '';

    /*-------------------------------------------------------------------------------------------------
    Build UI Components
    -------------------------------------------------------------------------------------------------*/
    this.style.resize = "both";
    this.style.zIndex = 0;

    var IconURL = 'favicon.ico', treeparent = (Attributes.owner ? Attributes.owner.TreeItem : Attributes.root.Treebar);
    if (/^(status|channel|query)$/i.test(Attributes.type)) { IconURL = "images/" + Attributes.type + ".ico"; }

    this.setWindowIcon(IconURL);
    this.setWindowTitle((Attributes.title || Attributes.target));

    this.TreeItem = new QTreeWidgetItem(IconURL,Attributes.target,treeparent).connect('itemClicked',this,() => { if (Array.isArray(this.parent()._MetaObject) && this.parent()._MetaObject.includes('QMdiArea')) { this.parent().setActiveSubWindow(this); } });
    this.Container = QuickElement('div',{style: 'display: flex; flex-direction: column; flex: auto; overflow: hidden;'},'',this._CentralWidget);
    if (Attributes.type == 'channel') {
      this.ListDock = new QDockWidget('Nicklist').setBaseSize(100,null).setResizable(false).setAllowedAreas(Qt.DockWidgetArea.LeftDockWidgetArea | Qt.DockWidgetArea.RightDockWidgetArea).setWindowFlag(Qt.WindowType.WindowUndockButtonHint,false).setWindowFlag(Qt.WindowType.WindowCloseButtonHint,false).setFeature(Qt.DockWidgetFeature.DockWidgetFloatable,false);
      this.List = new QListView(this.ListDock).setBaseSize(100,null);
      this.List.style.background = this._Color('listbox');
      this.List.style.color = this._Color('listboxtext');
      this.List.addEventListener('dblclick',(e) => { if (/^span$/i.test(e.target.tagName)) { this._Root._NewSubWindow(this._Cid,'query',e.target.parentNode.dataset.nick); } });
      this.addDockWidget(Qt.DockWidgetArea.RightDockWidgetArea,this.ListDock);

      this.Toolbar = new QToolBar();
      this.Info = new QAction('images/info.ico').setToolTip('Chan Info');
      this.Idle = new QAction('images/hourglass.ico').setToolTip('Channel Idle').setCheckable(true).connect('toggled',this,this._ToggleIdle);
      this.UserStats = new QAction('images/piechart.ico').setToolTip('User Statistics').setCheckable(true).connect('toggled',this,this._ToggleStats);
      this.ToggleNick = new QAction('images/users.ico').setToolTip('Toggle Nicklist').setCheckable(true).setChecked(true).connect('toggled',this,this._ToggleNicklist);
      this.Toolbar.addAction(this.Info);
      this.Toolbar.addAction(new QAction().setSeparator());
      this.Toolbar.addAction(this.Idle);
      this.Toolbar.addAction(this.UserStats);
      this.Toolbar.addAction(new QAction().setSeparator());
      this.Toolbar.addAction(this.ToggleNick);
      this.addToolBar(Qt.ToolBarArea.TopToolBarArea,this.Toolbar);

      //this.NickModeBar = new QToolBar();
      //Client.NickMode.split("").forEach((mode) => { 
      //  this.NickModeBar.addAction(new QAction('',"~" + mode).setToolTip('Toggle mode ' + mode).connect('triggered',this,() => { this._QuickMode(mode) }));
      //});
      //this.addToolBar(Qt.RightToolBarArea,this.NickModeBar);
      this.IdleContainer = QuickElement('span',{style: 'padding: 0 4px; display: none;'},'Idle: 0',this.statusBar());
      this.StatsContainer = QuickElement('span',{style: 'padding: 0 4px; display: none;'},'Count: 0',this.statusBar());
    }
    else if (Attributes.type == 'query') {
      this.Toolbar = new QToolBar();
      this.Info = new QAction('images/info.ico','',this.Toolbar).setToolTip('Whois Nick').connect('triggered',this,() => { this._Root._processInputLine(this,'/whois ' + this._Target); });
      this.addToolBar(Qt.ToolBarArea.TopToolBarArea,this.Toolbar);
    }
    else if (Attributes.type == 'status') {
      this.Toolbar = new QToolBar();
      this.QuickConnect = new QAction('images/star.ico').setToolTip('Favorites').setMenu();
      //new QAction('images/status.ico','ExampleNET',this.QuickConnect).connect('triggered',this,() => { this._Root._processInputLine(this,'/server ws://localhost:8000'); });
      new QAction('images/status.ico','SwiftIRC',this.QuickConnect).connect('triggered',this,() => { this._Root._processInputLine(this,'/server wss://fiery.swiftirc.net:4443'); });
      new QAction('images/status.ico','Libera.Chat',this.QuickConnect).connect('triggered',this,() => { this._Root._processInputLine(this,'/server wss://web.libera.chat/webirc/websocket/'); });
      new QAction('images/status.ico','WRNet',this.QuickConnect).connect('triggered',this,() => { this._Root._processInputLine(this,'/server wss://irc.wrestlingnewssource.com:8000'); });
      //new QAction('images/status.ico','mIRCScripts',this.QuickConnect).connect('triggered',this,() => { this._Root._processInputLine(this,'/server ws://irc.mircscripts.info:8000'); });

      this.NewSession = new QAction('images/addserver.ico').setToolTip('New Server Window').connect('triggered',this,() => { this._Root._NewSession() });
      this.ToggleOnline = new QAction('images/stopwatch.ico').setToolTip('Online Timer').setCheckable(true).connect('toggled',this,this._ToggleOnline);
      this.Toolbar.addAction(this.QuickConnect);
      this.Toolbar.addAction(new QAction().setSeparator());
      this.Toolbar.addAction(this.NewSession);
      this.Toolbar.addAction(new QAction().setSeparator());
      this.Toolbar.addAction(this.ToggleOnline);
      this.addToolBar(Qt.ToolBarArea.TopToolBarArea,this.Toolbar);
      this.OnlineContainer = QuickElement('span',{style: 'padding: 0 4px; display: none'},'Online: -',this.statusBar());
    }
    if (/^(status|channel|query)$/i.test(Attributes.type)) { 
      this.ViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"},'',this.Container);
      this.ViewPort.style.background = this._Color('viewport');
      this.ViewPort.addEventListener('pointerup',(e) => { 
        var selectedText = window.getSelection().toString().replace(/\u200B/g, "");
        if (selectedText != '') { navigator.clipboard.writeText(selectedText); }
      });
      this.ViewPort.addEventListener('scroll',(e) => { this.ViewPort._LastTop = this.ViewPort.scrollTop; });
      //this._ViewPortObserver = new MutationObserver(this._Observation.bind(this));
      //this._ViewPortObserver.observe(this.ViewPort,{childList: true});

      this.EditBox = QuickElement('input',{type: "text", style: "background: inherit; color: inherit; border: 1px solid transparent"},'',this.Container);
      this.EditBox._OwnerWindow = this;
      this.EditBox.style.background = this._Color('editbox');
      this.EditBox.style.color = this._Color('editboxtext');
      this.EditBox.addEventListener('keydown',(e) => { this._Root._handleInput(this,e); });
      this.EditBox.addEventListener('paste',(e) => { 
        var lines = event.clipboardData.getData('Text').split("\n");
        if (lines.length > 1) {
          e.stopPropagation();
          e.preventDefault();
          lines.forEach((line) => { this._Root._processInputLine(this,line); });
        }
      });
      this._EditBoxHistory = [];

      if (!window.mobileCheck()) { this.EditBox.focus(); }
    }

    this._Root.Treebar.setCurrentItem(this.TreeItem);
    this.addEventListener('pointerup',(e) => { if (this.hasOwnProperty('EditBox') && !window.mobileCheck()) { this.EditBox.focus(); } });
    if (this._Type == "query") { this._updateTitle(); }
  }

  handleEvent(e) { 
    if (e.type == 'aboutToActivate') {
      this._Root.Treebar.setCurrentItem(this.TreeItem);
      this._Root._updateStatus();
      this._Highlight = 0;
      this.TreeItem._TreeLabel.style.color = this._Root._Config['palette'][([99,this._Root._Config['windows'].event,this._Root._Config['windows'].message,this._Root._Config['windows'].highlight][this._Highlight])];
      if (this.hasOwnProperty('ViewPort')) { this.ViewPort.scrollTop = this.ViewPort._LastTop; }
      if (this.hasOwnProperty('EditBox') && !window.mobileCheck()) { this.EditBox.focus(); }
    }
    else if (e.type == 'childEvent') {
      if (e.detail.QEvent == Qt.QEvent.Resize) {
        if (this.hasOwnProperty('Canvas')) {
          this.Canvas.setAttribute('width',this.Container.offsetWidth);
          this.Canvas.setAttribute('height',this.Container.offsetHeight);
        }
      }
      else if (e.detail.QEvent == Qt.QEvent.Close) {
        if (this._Type == 'status') { this._Root._CloseSession(this._Cid); }
        else { 
          if (this._Type == 'channel') {
            var Client = this._Root.Sessions[this._Cid].Client , IAL = Client.GetIAL(Client.Me);
            if (IAL && IAL.channels.hasOwnProperty(this._Target.toLowerCase())) { Client.WSSend("PART " + this._Target); }
          }
          this._Root._CloseSubWindow(this._Cid,this); 
        }
      }
    }
    super.handleEvent(e);
  }

  _Color(type,bool) { return this._Root._Color(type,bool); }
  _embedFragment(Async) {
    if (this.hasOwnProperty('ViewPort')) {
      if (this.hasOwnProperty('_DocumentFragment')) {
        var shouldscroll = ((this.ViewPort.scrollTop + this.ViewPort.clientHeight) == this.ViewPort.scrollHeight ? true : false);
        this.ViewPort.appendChild(this._DocumentFragment);
        delete this._DocumentFragment;
        if (shouldscroll) { this._scrollBottom(); }

      Async.forEach((id) => {
        AsyncEmbed(id).then((info) => {
          var shouldscroll = ((this.ViewPort.scrollTop + this.ViewPort.clientHeight) == this.ViewPort.scrollHeight ? true : false);
          var elem = document.getElementById(id);
          if (info.type == "image") {
            info.data.style.maxWidth = info.data.style.maxHeight = "300px";
            info.data.style.aspectRatio = info.data.naturalWidth + " / " + info.data.naturalHeight;
            elem.parentNode.insertBefore(info.data,elem);
            elem.parentNode.removeChild(elem);
          }
          else if (info.type == "audio" || info.type == "video") {
            elem.parentNode.insertBefore(info.data,elem);
            elem.parentNode.removeChild(elem);
          }
          else {
            elem.innerText = info.src;
            elem.removeAttribute('id');
          }
          if (shouldscroll) { this._scrollBottom(); }
        });
      });
      }
    }
  }
  _echo(highlight,color,string) {
    if (this.ViewPort.childNodes.length == this._Root._Config['windows'].buffer) { this.ViewPort.removeChild(this.ViewPort.firstElementChild); }
    var Async = [];
    if (!this.hasOwnProperty('_DocumentFragment')) { this._DocumentFragment = document.createDocumentFragment(); }

    if (this.hasOwnProperty('ViewPort')) {
      this._DocumentFragment.appendChild(QuickElement('span',{style:'color:' + color},this._Root.CC2Html(string + "\n").replace(/((?:https?|ftp):\/\/(?:[\w_-]+(?:(?:\.[\w_-]+)+))(?:[\w.,@?^=%&:/~+#-;]*[\w@?^=%&/~+#-])?)/ig,function(match,url) {   
        if (/^https?:\/\/(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)/g.test(url)) { return '<iframe width="320" height="280" src="//www.youtube.com/embed/' + RegExp.$1 + '" frameborder="0" allowfullscreen></iframe>'; }
        else {
          var rng = "AsyncEmbed-" + (Math.random() + 1).toString(36).substring(2);
          Async.push(rng);
          return '<a href="' + url + '" target="_blank"><span id="' + rng + '">' + url + '</span></a>';
        }
      })));
      window.requestAnimationFrame(() => { this._embedFragment(Async); });
    }

    if (this._Type == "query") { this._updateTitle(); }
    if (!this.TreeItem.isSelected() && highlight > this._Highlight) { this._Highlight = highlight; }
    this.TreeItem._TreeLabel.style.color = this._Root._Config['palette'][([99,this._Root._Config['windows'].event,this._Root._Config['windows'].message,this._Root._Config['windows'].highlight][this._Highlight])];
  }
  _scrollBottom() { 
    //We need to give the browser time to render, so a slight timeout before scrolling to the bottom is necessary...
    if (this.hasOwnProperty('ViewPort')) { setTimeout(() => { this.ViewPort.scrollTop = this.ViewPort.scrollHeight; }); }
  }
  _updateTypers(bool) {
    var typers = [] , remove = [] , now = Date.now();
    Object.keys(this._TypeObject).forEach((key) => { 
      if (now - this._TypeObject[key] < 6000) { typers.push(key); }
      else { remove.push(key); }
    });
    remove.forEach((key) => { delete this._TypeObject[key]; });

    if (typers.length > 0 && typers.length <= 3) { this.EditBox.setAttribute('placeholder',typers.join(", ").replace(/\x2c([^\x2c]*)$/," and$1") + " is typing..."); }
    else if (typers.length > 3) { this.EditBox.setAttribute('placeholder',"Multiple people are typing..."); }
    else { this.EditBox.setAttribute('placeholder',""); }
    if (!bool) { this._TypeTimer = setTimeout(() => { this._updateTypers(true); },6000); }
  }
  _updateTitle() {
    var Client = this._Root.Sessions[this._Cid].Client;
    if (this._Type == "status") { 
      this.TreeItem.setText((Client.Network != "" ? Client.Network : (Client.Server != "" ? Client.Server : "Status")) + (Client.Me != "" ? " " + Client.Me : ""));
      if (Client.Socket && Client.Socket.readyState == 1) { this.setWindowTitle("Status: " + Client.Me + " [+" + Client.UMode + "] on " + Client.Network + " (" + Client.Server + ")"); }
      else { this.setWindowTitle("Status: Not Connected"); }
    }
    else if (this._Type == "channel") {
      var Chan = Client.GetICL(this._Target);
      if (Chan) { this.setWindowTitle(this._Target + " (" + Client.Network + ") [" + Chan.Nicks.length + "] [+" + Chan.mode + "]: " + this._Root.CC2Html(Chan.topic)); }
      else { this.setWindowTitle(this._Target) }
    }
    else if (this._Type == "query") {
      var IAL = Client.GetIAL(this._Target);
      this.setWindowTitle(this._Target + " (" + Client.Network + ")" + (IAL ? " (" + IAL.address + ")" : ""));
    }
  }
  _ToggleOnline(e) {
    if (e.detail.checked) { this.OnlineContainer.style.display = null; this.Timer = setInterval(() => { this._updateOnline() },500); this._updateOnline(); }
    else { this.OnlineContainer.style.display = 'none'; this.Timer = clearInterval(this.Timer); }
  }
  _ToggleIdle(e) {
    if (e.detail.checked) { this.IdleContainer.style.display = null; this.Timer = setInterval(() => { this._updateIdle() },500); this._updateIdle(); }
    else { this.IdleContainer.style.display = 'none'; this.Timer = clearInterval(this.Timer); }
  }
  _updateIdle() { 
    var Client = this._Root.Sessions[this._Cid].Client , Chan = Client.GetICL(this._Target);
    if (Chan) {
      var dur = parseInt((Date.now() / 1000) - Chan.idle) , H = parseInt(dur / 3600) , M = parseInt((dur - H * 3600) / 60) , N = dur % 60
      this.IdleContainer.innerHTML = "Idle: " + H.toString().padStart(2,'0') + ":" + M.toString().padStart(2,'0') + ":" + N.toString().padStart(2,'0'); 
    }
    else { this.IdleContainer.innerHTML = "Idle: -"; }
  }
  _ToggleStats(e) {
    if (e.detail.checked) { this.StatsContainer.style.display = null; this._updateStats(); }
    else { this.StatsContainer.style.display = 'none'; }
  }
  _updateStats() { 
    var Client = this._Root.Sessions[this._Cid].Client , Chan = Client.GetICL(this._Target);
    if (Chan) {
      var keys = {};
      Client.Prefix.split("").forEach((key) => { keys[key] = 0; });
      Chan.Nicks.forEach((nick) => {
        var IAL = Client.GetIAL(nick);
        if (IAL.channels[this._Target.toLowerCase()] != '') { IAL.channels[this._Target.toLowerCase()].split("").forEach((key) => { keys[key]++; }); }
      });
      this.StatsContainer.innerHTML = JSON.stringify(keys).replace(/[\x22\x7B\x7D]/g,"").replace(/([\x2C\x3A])/g,(m) => { return m + " "; });
    }
    else { this.StatsContainer.innerHTML = ""; }
  }
  _updateOnline() { 
    var Client = this._Root.Sessions[this._Cid].Client , Time = Client.OTime;
    if (Time != '') {
      var dur = parseInt(Date.now() / 1000 - Time) , H = parseInt(dur / 3600) , M = parseInt((dur - H * 3600) / 60) , N = dur % 60
      this.OnlineContainer.innerHTML = "Online: " + H.toString().padStart(2,'0') + ":" + M.toString().padStart(2,'0') + ":" + N.toString().padStart(2,'0'); 
    }
    else { this.OnlineContainer.innerHTML = 'Online: -'}
  }

  _ToggleNicklist(e) {
    if (e.detail.checked) { this.ListDock.show(); }
    else { this.ListDock.hide(); }
  }
  _handleNickListEvent(event,nick,newnick) {
    var Client = this._Root.Sessions[this._Cid].Client , Chan = Client.GetICL(this._Target);
    if (/^(?:part|quit|kick)$/.test(event)) {
      var NickAction = this.List.querySelector("[data-nick='" + encodeURIComponent(nick) + "']");
      if (NickAction) { this.List.removeAction(NickAction); }
    }
    else if (event == 'join') {
      var IAL = Client.GetIAL(nick), Index = Chan.Nicks.indexOf(nick);
      if (IAL.channels.hasOwnProperty(this._Target.toLowerCase())) {
        var item = new QAction('',IAL.channels[this._Target.toLowerCase()].substr(0,1) + nick);
        item.dataset.nick = encodeURIComponent(nick);
        if (Index < Chan.Nicks.length-1) { this.List.insertAction(this.List._CentralWidget.childNodes[Index],item); }
        else { this.List.addAction(item); }
      }
    }
    else if (event == 'nick') {
      var NickAction = this.List.querySelector("[data-nick='" + encodeURIComponent(nick) + "']");
      if (NickAction) {
        var IAL = Client.GetIAL(newnick) , Index = Chan.Nicks.indexOf(newnick);
        this.List.removeAction(NickAction);
        NickAction.setText(IAL.channels[this._Target.toLowerCase()].substr(0,1) + newnick);
        NickAction.dataset.nick = encodeURIComponent(newnick);
        if (Index < Chan.Nicks.length-1) { this.List.insertAction(this.List._CentralWidget.childNodes[Index],NickAction); }
        else { this.List.addAction(NickAction); }
      }
    }
    else if (event == 'mode') {
      var nicks = new Set(nick.split(/ /).slice(1));
      nicks.forEach((Nick) => {
        if (Client.isOn(Nick,this._Target)) {
          var NickAction = this.List.querySelector("[data-nick='" + encodeURIComponent(Nick) + "']");
          if (NickAction) {
            var IAL = Client.GetIAL(Nick) , Index = Chan.Nicks.indexOf(Nick);
            this.List.removeAction(NickAction);
            NickAction.setText(IAL.channels[this._Target.toLowerCase()].substr(0,1) + Nick);
            NickAction.dataset.nick = encodeURIComponent(Nick);
            if (Index < Chan.Nicks.length-1) { this.List.insertAction(this.List._CentralWidget.childNodes[Index],NickAction); }
            else { this.List.addAction(NickAction); }
          }
          else { console.log("Nicklist Error! " + Nick + " was not found!"); }
        }
      });
    }
    this._updateStats();
  }
  _SortTree() {
    var Client = this._Root.Sessions[this._Cid].Client , array = this.TreeItem.Children();
    var sorted = array.sort((a,b) => {
      var c = Client.isChan(a._TreeLabel.innerText), d = Client.isChan(b._TreeLabel.innerText);
      if (c && !d) { return -1; }
      if (!c && d) { return 1; }
      return 0;
    });
    sorted.forEach((item) => { item.parentNode.appendChild(item); });
  }
}
customElements.define('web-customwindow', CustomWindow);

window.addEventListener('load',() => {
  var App = new WebIRC();

  //Hack to force active the subwindow to scroll to bottom when the virtual keyboard opens...
  if (window.mobileCheck()) { 
    window.addEventListener('resize',(e) => { 
      var Active = document.activeElement;
      if (Active && Active.hasOwnProperty('_OwnerWindow')) { Active._OwnerWindow._scrollBottom(); }
    });
  }
});
      </script>
    </head>
  <body>
    <div id="helpabout" style="display: none; overflow: auto;">
      <table>
        <tr>
          <td valign="top"><img src='./favicon.ico'></div></td>
          <td>
            Web-IRC&reg;<br>Internet Relay Chat Client<p>
              By Sean Everett (Talon)<p>
              Copyright &copy; 2022<br>
              Talon Co. Ltd.<br>
              All Rights Reserved.<p>
              <a href='https://chat.swiftirc.net/' target='_blank'>https://chat.swiftirc.net/</a><p>
              Special Thanks to: Ryan William O'Hara (Dragon) and all other contributers and users! 
          </td>
        </tr>
      </table>
    </div>
    <div id="helpdoc" style="display: none; overflow: auto;">
      <h1>Key Combinations:</h1>
      <hr>
      <h2>Shift+Tab</h2>
      This cycles between all MDI subwindows by order of creation.
      <p></p>

      <h2>Editbox Cursor Up/Down</h2>
      This browses the history of a windows editbox. (previously sent commands/lines)
      <p></p>

      <h2>Editbox Ctrl+Enter</h2>
      If you want to send information beginning with the / command prefix and you want it to be sent as normal text instead of interpreted as a command, just hold down the Control key when you press enter.
      <p></p>

      <h2>Editbox Ctrl+BURKIEDQO</h2>
      Inserts control codes for Bold, Underline, Reverse, Color, Italic, Strikethru, HexColor, Monospace and the stop all controls character. 
      <p></p>

      <h2>Editbox Tab Key</h2>
      If you are in a channel window editbox and it contains some text, the Tab key performs nickname completion on the word the cursor is on, this allows you type in only the first character or two of a nickname on that channel and then press Tab and Web-IRC will expand it to the full nickname. You can cycle thru all matches with multiple presses of Tab. This replacement ends when ANY key other than tab is pressed.
      <p></p>

      <hr>
      <h1>Basic IRC Commands:</h1>
      <hr>
      <h2>/away [message]</h2>
      Leaves a message indicating that you are currently not paying attention to IRC. When someone sends you a message, they will automatically see your away message. Using /AWAY with no message marks you as no longer being away and removes your previous message.
      <p></p>

      <h2>/invite nickname #channel</h2>
      Invites a nickname to a channel that you are on.
      <p></p>

      <h2>/join #channel,#channel,etc...</h2>
      Joins the specified channel(s).
      <p></p>

      <h2>/kick #channel nickname [reason]</h2>
      Kicks a nickname off a channel that you are on and optionally attaches a reason.
      <p></p>
      
      <h2>/mode [#channel|nickname] [[+|-]modechars [parameters]]</h2>
      Sets/unsets nickname modes or channel modes.
      <p></p>

      <h2>/nick nickname</h2>
      Changes your nickname to a new nickname.
      <p></p>

      <h2>/part #channel,#channel,etc... [message]</h2>
      Leaves the specified channel(s) that you are on and optionally attaches a part message.
      <p></p>
      
      <h2>/quit [message]</h2>
      Disconnects you from IRC and will give the optional message as the reason for your departure. (this message only appears to people who are on the same channels as you).
      <p></p>
      
      <h2>/topic #channel newtopic</h2>
      Changes the topic for a channel that you are on.
      <p></p>
                                    
      <h2>/whois nickname</h2>
      Shows you information about a nickname.
      <p></p>
                                    
      <hr>
      <h1>Web-IRC Commands:</h1>
      <hr>
      <h2>/ame &lt;message&gt;</h2>
      This command sends the specified action to all open channel windows.
      <p></p>

      <h2>/amsg &lt;message&gt;</h2>
      This command sends the specified message to all open channel windows.
      <p></p>

      <h2>/channel [#channel]</h2>
      Pops up the channel central window for the channel window you are currently in. You can also specify a #channel name to open the channel central for a channel you have already joined but which is not the active window.
      <p></p>

      <h2>/clear [-hcqns] [windowname]</h2>
      Clears the buffer of the current window. If you specify a window name, that window's buffer will be cleared.<br>
      The -s switch clears the status window.<br>
      The -h switch clears the editbox command history for a window.      
      <p></p>
      
      <h2>/clearall [-snqma]</h2>
      Clears the buffers of the specified windows, where s = status, n = channel, q = query, m = monitor panels, a = all windows on all connections.<br>
      If no switches are specified all windows are cleared.      
      <p></p>

      <h2>/disconnect</h2>
      Forces a disconnect from a server. This is different from the /quit command which sends a quit message to the server and waits for the server to disconnect you.
      <p></p>
            
      <h2>/ebeeps &lt;on|[off]&gt;</h2>
      Enables or disables all event beeps. Events such as new lines in a window when the scrollbar is NOT at the bottom.
      <p></p>

      <h2>/help</h2>
      Opens up the Help Documentation.
      <p></p>

      <h2>/links [-nx]</h2>
      Retrieves the servers to which your current server is linked.<br>
      The -n and -x switches minimize/maximize the window when it opens.
      <p></p>
      
      <h2>/me message</h2>
      Sends an action message to the current channel or query window. To send an action message to a specific channel or nickname, see the /describe command.
      <p></p>

      <h2>/menubar &lt;on|[off]&gt;</h2>
      Changes the menubar display state. Default with no parameter is off.
      <p></p>

      <h2>/msg or /privmsg target message</h2>
      Sends a private message to the target.<br>
      Note: If the target is a nickname, this will send without opening a query window.
      <p></p>
      
      <h2>/notice target message</h2>
      Sends a notice to the target with specified message. 
      <p></p>
      
      <h2>/partall [message]</h2>
      Leaves all channels that you are on and optionally attaches a part message.
      <p></p>
      
      <h2>/query nickname</h2>
      Opens a query window to this specific nickname. If it's already opened, it will set the query window the active window.
      <p></p>

      <h2>/raw or /quote &lt;command&gt;</h2>
      Sends the specified command directly to the server. You must know the correct raw format of the command you are sending.
      <p></p>

      <h2>/say message</h2>
      This sends a message to the current channel or query window. So "/say Hello there" would be the same as just typing "Hello there".
      <p></p>

      <h2>/server [-i nick] [-j chan1,etc..] [-mn] &lt;server&gt;</h2>
      Connects you to a server, first disconnecting you from the current server.<br>
      Note: Servers are in form of: ws(s)://server:port/optionalPaths/<br>
      The -i switch sets the nickname to be used when connecting to server.<br>
      The -j switch sets the channels to join when connected to server.<br>
      The -m switch creates a new server window for that connection and connects to the server. The -n switch does the same thing but does not connect to the server.<br>
      <p></p>
      
      <h2>/statusbar &lt;on|[off]&gt;</h2>
      Changes the statusbar display state. Default with no parameter is off.
      <p></p>

      <h2>/toolbar &lt;on|[off]&gt;</h2>
      Changes the toolbar display state. Default with no parameter is off.
      <p></p>

      <h2>/treebar &lt;on|[off]&gt;</h2>
      Changes the treebar display state. Default with no parameter is off.
      <p></p>

    </div>
  </body>
</html>