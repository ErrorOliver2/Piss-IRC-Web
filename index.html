<!DOCTYPE html> 
  <html>
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=0'>
      <title>Web-IRC</title>
      <link rel="stylesheet" href="style.css">
      <script src="DragDropTouch.js"></script>
      <script src="jsqtv4.js"></script>
      <script src="ircclient.js"></script>
      <script>
function AscTime(date,format) {
  let DayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"] , MonthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  let Second = date.getSeconds(), Minute = date.getMinutes(), Hour = date.getHours(), Day = date.getDay(), Month = date.getMonth(), Year = date.getFullYear(), OffsetHrs = date.getTimezoneOffset() / -60, OffsetMns = (Math.abs(OffsetHrs) % 1 * 60).toString().padStart(2,0);
  OffsetHrs = parseInt(OffsetHrs);
  return format.replace(/(yy(?:yy)?|m{1,4}|d{1,4}|z{1,3}|HH?|hh?|nn?|ss?|TT?|tt?)/g, function(m,i) {
    let chr = i.substr(0,1);
    if (chr == "y") { return Year.toString().substr((i.length <= 2 ? 2 : 0)); }
    else if (chr == "m") { return (i.length < 3 ? (Month + 1).toString().padStart(i.length,0) : (i.length < 4 ? MonthNames[Month].substring(0,i.length) : MonthNames[Month])); }
    else if (chr == "d") { return (i.length < 3 ? date.getDate().toString().padStart(i.length,0) : (i.length < 4 ? DayNames[Day].substring(0,i.length) : DayNames[Day])); }
    else if (chr == "H") { return (i.length == 2 ? Hour.toString().padStart(2,0) : Hour); }
    else if (chr == "h") { return (Hour < 12 ? (i.length == 2 ? Hour.toString().padStart(2,0) : Hour) : (i.length == 2 ? (Hour - 12).toString().padStart(2,0) : (Hour - 12))); }
    else if (chr == "n") { return (i.length == 2 ? Minute.toString().padStart(2,0) : Minute); }
    else if (chr == "s") { return (i.length == 2 ? Second.toString().padStart(2,0) : Second); }
    else if (chr == "T") { return (Hour < 12 ? "AM" : "PM").substr(0,i.length); }
    else if (chr == "t") { return (Hour < 12 ? "am" : "pm").substr(0,i.length); }
    else if (chr == "z") { return (OffsetHrs < 0 ? '-' : '+') + (i.length < 3 ? (i.length == 1 ? Math.abs(OffsetHrs) : Math.abs(OffsetHrs).toString().padStart(2,0) + OffsetMns) : Math.abs(OffsetHrs).toString().padStart(2,0) + OffsetMns + " GMT"); }
  }).replace(/(1?\d)oo/g,function(m,i) { return i + ([0,'st','nd','rd'][i]||'th'); });  
}

/*================================================================================================
Simple Web-UI MDI interface
================================================================================================*/

class WebMDI extends QMainWindow {
  constructor() {
    //set window flags (get rid of WindowTitleHint we're not floating this...)
    var flags = Qt.Window;
    super(null,flags);

    /*-------------------------------------------------------------------------------------------------
	  Private Properties
    -------------------------------------------------------------------------------------------------*/
    this._Base.push("WebMDI");
    this.classList.add("WebMDI");
    this._Config = {
      'palette': new Array("#FFFFFF","#000000","#00009D","#009300","#FF0000","#7F0000","#9C009C","#FC7F00","#FFFF00","#00FC00","#009393","#00FFFF","#0000FC","#FF00FF","#7F7F7F","#D2D2D2","#470000","#472100","#474700","#324700","#004700","#00472C","#004747","#002747","#000047","#2E0047","#470047","#47002A","#740000","#743A00","#747400","#517400","#007400","#007449","#007474","#004074","#000074","#4B0074","#740074","#740045","#B50000","#B56300","#B5B500","#7DB500","#00B500","#00B571","#00B5B5","#0063B5","#0000B5","#7500B5","#B500B5","#B5006B","#FF0000","#FF8C00","#FFFF00","#B2FF00","#00FF00","#00FFA0","#00FFFF","#008CFF","#0000FF","#A500FF","#FF00FF","#FF0098","#FF5959","#FFB459","#FFFF71","#CFFF60","#6FFF6F","#65FFC9","#6DFFFF","#59B4FF","#5959FF","#C459FF","#FF66FF","#FF59BC","#FF9C9C","#FFD39C","#FFFF9C","#E2FF9C","#9CFF9C","#9CFFDB","#9CFFFF","#9CD3FF","#9C9CFF","#DC9CFF","#FF9CFF","#FF94D3","#000000","#131313","#282828","#363636","#4D4D4D","#656565","#818181","#9F9F9F","#BCBCBC","#E2E2E2","#FFFFFF","#D2D2D2"),
      'colors': {
        'action':7,
        'ctcp':4,
        'highlight':4,
        'info':3,
        'invite':3,
        'join':10,
        'kick':4,
        'mode':4,
        'nick':10,
        'normal':'inherit',
        'notice':7,
        'own':'inherit',
        'part':10,
        'topic':3,
        'quit':12,
      },
      'options': { 
        'irc': {
          'reconnect': true,
          'showprefix': true,
          'kickrejoin': true,
          'connectrejoin': true,
          'keepchanopen': true,
          'timestamp': true,
          'timestampformat': '[HH:nn]',
          'quitmsg': '',
        }
      },
      'windows': { 
        'event':12,
        'message':4,
        'highlight':9,
        'buffer': 5000,
      },

    };
    this.Windows = { };

    /*-------------------------------------------------------------------------------------------------
    Build UI Components
    -------------------------------------------------------------------------------------------------*/
    this.setWindowTitle("Web-IRC"); //for giggles just incase we setwindowflags to give back titlehint...

    //Build Menus
    this.mFile = new QMenu('File');
      this.fNew = new QAction('images/status.ico','New Server Window',this.mFile).connect('triggered',this,() => { this._NewSession('','',''); });
      new QAction('','',this.mFile).setSeparator();
      this.fOptions = new QAction('images/options.ico','Options',this.mFile);
    this._MenuBar.addMenu(this.mFile);

    this.mView = new QMenu('View');
      this.vFull = new QAction('','Fullscreen',this.mView).connect('triggered',this,this._ToggleFullscreen);
      new QAction('','',this.mView).setSeparator();
      this.vMenu = new QAction('','Menubar',this.mView).connect('triggered',this,this._ToggleMenubar);
      this.vTool = new QAction('','Toolbar',this.mView).connect('triggered',this,this._ToggleToolbar);
      this.vTool = new QAction('','Treebar',this.mView).connect('triggered',this,this._ToggleTreebar);
      this.vStatus = new QAction('','Statusbar',this.mView).connect('triggered',this,this._ToggleStatus);
      new QAction('','',this.mView).setSeparator();
      this.vMPToggle = new QAction('','Toggle All Monitor Panels',this.mView).connect('triggered',this,this._ToggleAll);
      new QAction('','',this.mView).setSeparator();
      this.vChan = new QAction('','Channel Messages',this.mView).connect('triggered',this,this._ToggleChan);
      this.vHighlight = new QAction('','Highlights',this.mView).connect('triggered',this,this._ToggleHighlight);
      this.vNotice = new QAction('','Notices',this.mView).connect('triggered',this,this._ToggleNotice);
      this.vQuery = new QAction('','Private Messages',this.mView).connect('triggered',this,this._ToggleQuery);
      this.vServer = new QAction('','Server Messages',this.mView).connect('triggered',this,this._ToggleServer);
    this._MenuBar.addMenu(this.mView);
    
    this.MDI = new QMdiArea(this);
    this.TreeDock = new QDockWidget('Treebar').setAllowedAreas(Qt.RightDockWidgetArea | Qt.LeftDockWidgetArea).setBaseSize(150,null).setResizable(true);
    this.Treebar = new QTreeWidget();
    this.TreeDock.setCentralWidget(this.Treebar);
    this.addDockWidget(Qt.LeftDockWidgetArea,this.TreeDock);

    this.MonitorChan = new QDockWidget('Channel Messages').setAllowedAreas(Qt.TopDockWidgetArea | Qt.RightDockWidgetArea | Qt.BottomDockWidgetArea | Qt.LeftDockWidgetArea).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorChanViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorChan.setCentralWidget(this.MonitorChanViewPort);
    this.MonitorHighlight = new QDockWidget('Highlights').setAllowedAreas(Qt.TopDockWidgetArea | Qt.RightDockWidgetArea | Qt.BottomDockWidgetArea | Qt.LeftDockWidgetArea).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorHighlightViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorHighlight.setCentralWidget(this.MonitorHighlightViewPort);
    this.MonitorNotice = new QDockWidget('Notices').setAllowedAreas(Qt.TopDockWidgetArea | Qt.RightDockWidgetArea | Qt.BottomDockWidgetArea | Qt.LeftDockWidgetArea).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorNoticeViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorNotice.setCentralWidget(this.MonitorNoticeViewPort);
    this.MonitorQuery = new QDockWidget('Private Messages').setAllowedAreas(Qt.TopDockWidgetArea | Qt.RightDockWidgetArea | Qt.BottomDockWidgetArea | Qt.LeftDockWidgetArea).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorQueryViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
    this.MonitorQuery.setCentralWidget(this.MonitorQueryViewPort);
    this.MonitorServer = new QDockWidget('Server Messages').setAllowedAreas(Qt.TopDockWidgetArea | Qt.RightDockWidgetArea | Qt.BottomDockWidgetArea | Qt.LeftDockWidgetArea).setMinimumSize(75,75).setBaseSize(75,75).setVisible(false).setResizable(true);
    this.MonitorServerViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll; "});
    this.MonitorServer.setCentralWidget(this.MonitorServerViewPort);

    this.addDockWidget(Qt.BottomDockWidgetArea,this.MonitorChan);
    this.addDockWidget(Qt.BottomDockWidgetArea,this.MonitorHighlight);
    this.addDockWidget(Qt.BottomDockWidgetArea,this.MonitorNotice);
    this.addDockWidget(Qt.BottomDockWidgetArea,this.MonitorQuery);
    this.addDockWidget(Qt.BottomDockWidgetArea,this.MonitorServer);

    this.Toolbar = new QToolBar();
    this.Toolbar.addAction(new QAction('images/options.ico').setToolTip('Options'));
    this.Toolbar.addAction(new QAction('images/colors.ico').setToolTip('Colors'));
    this.Toolbar.addAction(new QAction('','').setSeparator());
    this.Toolbar.addAction(new QAction('images/monitor.ico').setToolTip('Toggle Monitor Panels').connect('triggered',this,this._ToggleAll));
    this.addToolBar(Qt.TopToolBarArea,this.Toolbar);

    /*-------------------------------------------------------------------------------------------------
    Setup Event Listeners
    -------------------------------------------------------------------------------------------------*/

    /*-------------------------------------------------------------------------------------------------
    Call any initializing routines
    -------------------------------------------------------------------------------------------------*/
    var params = new Proxy(new URLSearchParams(window.location.search), { get: (searchParams, prop) => searchParams.get(prop), });
    this._NewSession('','',(params.perform ? params.perform : ''));
  }
  
  /*-------------------------------------------------------------------------------------------------
  Default Callbacks and Event Handler
  -------------------------------------------------------------------------------------------------*/
  connectedCallback() { super.connectedCallback(); }
  disconnectedCallback() { super.disconnectedCallback(); }
  handleEvent(e) { super.handleEvent(e); }
 
  /*-------------------------------------------------------------------------------------------------
  Private Functions
  -------------------------------------------------------------------------------------------------*/
  _ToggleAll() {
    this.MonitorChan.setVisible((this.MonitorChan.isVisible() == true ? false : true));
    this.MonitorHighlight.setVisible((this.MonitorHighlight.isVisible() == true ? false : true));
    this.MonitorNotice.setVisible((this.MonitorNotice.isVisible() == true ? false : true));
    this.MonitorQuery.setVisible((this.MonitorQuery.isVisible() == true ? false : true));
    this.MonitorServer.setVisible((this.MonitorServer.isVisible() == true ? false : true));
  }
  _ToggleFullscreen() { 
    if (document.fullscreenElement == null) { document.documentElement.requestFullscreen(); }
    else { document.exitFullscreen(); }
  }
  _ToggleChan() { this.MonitorChan.setVisible((this.MonitorChan.isVisible() == true ? false : true)); }
  _ToggleHighlight() { this.MonitorHighlight.setVisible((this.MonitorHighlight.isVisible() == true ? false : true)); }
  _ToggleMenubar() { }
  _ToggleNotice() { this.MonitorNotice.setVisible((this.MonitorNotice.isVisible() == true ? false : true)); }
  _ToggleQuery() { this.MonitorQuery.setVisible((this.MonitorQuery.isVisible() == true ? false : true)); }
  _ToggleServer() { this.MonitorServer.setVisible((this.MonitorServer.isVisible() == true ? false : true)); }
  _ToggleStatus() { }
  _ToggleToolbar() { this.Toolbar.setVisible((this.Toolbar.isVisible() == true ? false : true)); }
  _ToggleTreebar() { this.TreeDock.setVisible((this.TreeDock.isVisible() == true ? false : true)); }
  _NewSession(Nick,Server,Perform) {
    var x = 1;
    Object.keys(this.Windows).forEach((target) => { if ("" + x + "" == target) { x++; } });
    this.Windows[x] = { Windows: { "status window": new CustomWindow(this,x,"status window",{ target: "Status Window", mdi: true, state: "normal", type: "status", cid: x, lb: 0, eb: 0 }) } };
    var Client = this.Windows[x].Windows["status window"]._Client;
    if (Nick != '') { Client.Me = Nick; }
    if (/^wss?:\/\//i.test(Server)) { Client.WSConnect(Client.Me,Server,['text.ircv3.net']); }
    if (Perform != "") { this.Windows[x].Windows["status window"].EditBox.value = Perform; }
    setTimeout(() => { this.Windows[x].Windows["status window"]._activate(); });
  }
  _NewWindow(cid,name,Data) {
    if (this.Windows.hasOwnProperty(cid) && !this.Windows[cid].Windows.hasOwnProperty(name.toLowerCase())) {
      this.Windows[cid].Windows[name.toLowerCase()] = new CustomWindow(this,cid,name,Data);
      setTimeout(() => { this.Windows[cid].Windows[name.toLowerCase()]._activate(); });
    }
  }
  _Echo(cid,target,highlight,color,line) {
    if (this.Windows.hasOwnProperty(cid) && this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) {
      var Stamp = (this._Config['options']['irc'].timestamp ? AscTime(new Date(),this._Config['options']['irc'].timestampformat) + " " : "");
      this.Windows[cid].Windows[target.toLowerCase()]._echo(highlight,color,Stamp + line);
      if (this.Windows[cid].Windows[target.toLowerCase()]._Type == "status") {
        var Client = this.Windows[cid].Windows[target.toLowerCase()]._Client;
        this._MonitorEcho(this.MonitorServerViewPort,color,(Client.Network != "" ? Client.Network : Client.Server) + ": " + line)
      }
    }
    else { console.log('Error: ' + cid + " has no window: " + target); }
  }
  _MonitorEcho(target,color,string) {
    var Stamp = (this._Config['options']['irc'].timestamp ? AscTime(new Date(),this._Config['options']['irc'].timestampformat) + " " : "");
    var tmp = document.createElement('span');
    tmp.innerHTML = this.CC2Html(color,Stamp + string,0,0,0) + "\n";
    target.appendChild(tmp);      
    setTimeout(() => { target.scrollTop = target.scrollHeight; });   
  }
  _processInputLine(Sender,line) {
    var Client = this.Windows[Sender._CID].Windows['status window']._Client;
	  if (line.match(/^(\x2f+[^ ]+) ?((?: ?[+-][^-+ ]+(?: [^ ]+)?)*) ?(.*)$/)) {
      var Cmd = RegExp.$1 , Flags = RegExp.$2, Extra = RegExp.$3 || '';
      //console.log('CMD: ' + Cmd + ' F: ' + Flags + ' Extra: ' + Extra);
        
      //Single Tier Cmds (No Flags)
      if (/^\x2f+ame$/i.test(Cmd)) {
        Object.keys(this.Windows[Sender._CID].Windows).forEach((win) => { 
          if (Client.isChan(win)) {
            Sender._MainApp._SendData(Client,'PRIVMSG ' + win + ' :ACTION ' + Extra + ''); 
            Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + win + ' :ACTION ' + Extra + '');
          }
        }); 
      }
      else if (/^\x2f+amsg$/i.test(Cmd)) {
        Object.keys(this.Windows[Sender._CID].Windows).forEach((win) => { 
          if (Client.isChan(win)) {
            Sender._MainApp._SendData(Client,'PRIVMSG ' + win + ' :' + Extra);
            Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + win + ' :' + Extra);
          }
        }); 
      }
      else if (/^\x2f+away$/i.test(Cmd)) { Sender._MainApp._SendData(Client,'AWAY' + (Extra != "" ? " :" + Extra : "")); }
      //else if (/^\x2f+channel$/i.test(Cmd)) { } /* GUI Chan Central */
      else if (/^\x2f+disconnect$/i.test(Cmd)) { Client.WSClose(); }
      //else if (/^\x2f+invite$/i.test(Cmd)) { } /* Should be built in on an irc server? */
      else if (/^\x2f+kick$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ([^ ]+) ?(.*)$/)) { Sender._MainApp._SendData(Client,'KICK ' + RegExp.$1 + '' + RegExp.$2 + ' :' + RegExp.$3); } }
      //else if (/^\x2f+links$/i.test(Cmd)) { }
      //else if (/^\x2f+list$/i.test(Cmd)) { }
      else if (/^\x2f+(?:priv)?msg$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ?(.*)$/)) { Sender._MainApp._SendData(Client,'PRIVMSG ' + RegExp.$1 + ' :' + RegExp.$2); } }
      else if (/^\x2f+notice$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ?(.*)$/)) { Sender._MainApp._SendData(Client,'NOTICE ' + RegExp.$1 + ' :' + RegExp.$2); } }
      else if (/^\x2f+part$/i.test(Cmd)) { Sender._MainApp._SendData(Client,'PART ' + Extra); }
      else if (/^\x2f+partall$/i.test(Cmd)) { Object.keys(this.Windows[Sender._CID].Windows).forEach((win) => { if (Client.isChan(win)) { Sender._MainApp._SendData(Client,'PART ' + win); } }); }
      else if (/^\x2f+topic$/i.test(Cmd)) { if (Extra.match(/^([^ ]+) ?(.*)$/)) { Sender._MainApp._SendData(Client,'TOPIC ' + RegExp.$1 + ' :' + RegExp.$2); } }
      else if (/^\x2f+query$/i.test(Cmd)) { 
        if (!this.Windows[Sender._CID].Windows.hasOwnProperty(Extra.toLowerCase())) { this._NewWindow(Sender._CID,Extra.toLowerCase(),{ "target": Extra, mdi: true, state: "normal", type: "query", cid: Sender._CID }); }
        else { this.MDI.setActiveSubWindow(this.Windows[Sender._CID].Windows[Extra.toLowerCase()]); }
      }
      else if (/^\x2f+raw|quote$/i.test(Cmd)) { Sender._MainApp._SendData(Client,Extra); }
      //Window specific cmds
      else if (/^\x2f+me$/i.test(Cmd)) {
        if (/^(channel|query)$/i.test(Sender._Type)) { 
          Sender._MainApp._SendData(Client,'PRIVMSG ' + Sender._Name + ' :ACTION ' + Extra + ''); 
          Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + Sender._Name + ' :ACTION ' + Extra + '');
        }
      }
      else if (/^\x2f+say$/i.test(Cmd)) { 
        if (/^(channel|query)$/i.test(Sender._Type)) { 
          Sender._MainApp._SendData(Client,'PRIVMSG ' + Sender._Name + ' :' + Extra); 
          Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + Sender._Name + ' :' + Extra);
        }
      }

      //Multi Tier Cmds (With Flags)
      //else if (/^ban$/i.test(Cmd)) { }
      else if (/^\x2f+clear$/i.test(Cmd)) { Sender.ViewPort.innerHTML = ""; }
      else if (/^\x2f+clearall$/i.test(Cmd)) { 
        if (Flags == "" || Flags.indexOf('s') > -1) { Object.keys(this.Windows).forEach((cid) => { this.Windows[cid].Windows['status window'].ViewPort.innerHTML = ""; }); }
        if (Flags == "" || Flags.indexOf('n') > -1) { Object.keys(this.Windows).forEach((cid) => { Object.keys(this.Windows[cid].Windows).forEach((win) => { if (this.Windows[cid].Windows[win]._Type == "channel") { this.Windows[cid].Windows[win].ViewPort.innerHTML = ""; } }); }); }
        if (Flags == "" || Flags.indexOf('q') > -1) { Object.keys(this.Windows).forEach((cid) => { Object.keys(this.Windows[cid].Windows).forEach((win) => { if (this.Windows[cid].Windows[win]._Type == "query") { this.Windows[cid].Windows[win].ViewPort.innerHTML = ""; } }); }); }
        if (Flags == "" || Flags.indexOf('a') > -1) { Object.keys(this.Windows).forEach((cid) => { Object.keys(this.Windows[cid].Windows).forEach((win) => { this.Windows[cid].Windows[win].ViewPort.innerHTML = ""; }); }); }
      }
      //else if (/^\x2f+close$/i.test(Cmd)) { }
      else if (/^\x2f+join$/i.test(Cmd)) { 
        if (!this.Windows[Sender._CID].Windows.hasOwnProperty(Extra.toLowerCase())) { Sender._MainApp._SendData(Client,'JOIN ' + Extra); }
        else { 
          if (this.Windows[Sender._CID].Windows[Extra.toLowerCase()].List.children().length == 0) { Sender._MainApp._SendData(Client,'JOIN ' + Extra); }
          this.MDI.setActiveSubWindow(this.Windows[Sender._CID].Windows[Extra.toLowerCase()]); 
        }
      }
      else if (/^\x2f+server$/i.test(Cmd)) {
        var Nick = (Client.Me != '' ? Client.Me : 'Guest-' + (Math.random() + 1).toString(36).substring(7)) , Server = Extra , NS = false;
        if (Flags.indexOf(' ') > -1) {
          if (/-m ([^ ]+)/.test(Flags)) { Server = RegExp.$1; NS = true; }
          if (/-i ([^ ]+)/.test(Flags)) { Nick = RegExp.$1; }
        }
        else if (Flags.indexOf('n') > -1) { this._NewSession(Nick,''); }
        if (NS == true) { this._NewSession(Nick,Server); }
        else if (/^wss?:\/\//i.test(Server)) { Client.WSConnect(Nick,Server,['text.ircv3.net']); }
      }
      else { Sender._MainApp._SendData(Client,Cmd.substr(1) + ' ' + Extra); }
    }
    else if (line != "") { 
      if (/^(channel|query)$/i.test(Sender._Type)) {
        Sender._MainApp._SendData(Client,'PRIVMSG ' + Sender._Name + " :" + line); 
        Client.ParseLine(':' + Client.address(Client.Me,5) + ' PRIVMSG ' + Sender._Name + " :" + line);
      }
      else {
        console.log('erm? '+ line);
      }
    }
    if (line != "") {
      Sender._EditBoxHistory.push(line);
      Sender.EditBox.value = '';
      Sender.EditBox.dataset.hindex = Sender._EditBoxHistory.length;
    }
  }
  _handleInput(Sender,e) { 
    var key = e.keyCode || e.charCode;
    //handle enter in editbox (send)
    if (key == 13 || key == 10) { Sender._MainApp._processInputLine(Sender,Sender.EditBox.value); }

    //handle editbox history (up/dn arrows)
    else if (key == 38 || key == 40) {
      var dir = key - 39 , LastHistory = parseInt(Sender.EditBox.dataset.hindex) , hindex = LastHistory + dir;
      if (Sender._EditBoxHistory.length > 0 && hindex < Sender._EditBoxHistory.length) {
        if (hindex >= 0) { Sender.EditBox.value = Sender._EditBoxHistory[hindex]; Sender.EditBox.dataset.hindex = hindex; }
      }
      else if (hindex >= 0) { Sender.EditBox.value = ''; }
    }

    //handle ctrl+key shortcuts (control codes stuffs...)
    else if (e.ctrlKey) {
      var codes = [66,85,82,75,73,79] , chars = {'66':"",'85':"",'82':"",'75':"",'73':"",'79':""};
      if (codes.indexOf(key) > -1) {
        e.preventDefault(); 
        e.stopPropagation();
     
        if (Sender.EditBox.selectionStart || Sender.EditBox.selectionStart == '0') {
          var startPos = Sender.EditBox.selectionStart , endPos = Sender.EditBox.selectionEnd;
          Sender.EditBox.value = Sender.EditBox.value.substring(0, startPos) + chars[key] + Sender.EditBox.value.substring(endPos, Sender.EditBox.value.length); 
          Sender.EditBox.selectionStart = startPos + 1; 
          Sender.EditBox.selectionEnd = startPos + 1;
        }
        else { Sender.EditBox.value += chars[key]; }        
      }
    }

    //tab completion 
    else if (key == 9) {
      e.preventDefault();
      var Client = this.Windows[Sender._CID].Windows['status window']._Client;
      var ReTab = parseInt(Sender.EditBox.dataset.tabcomp) || Sender.EditBox.selectionStart;
      var preText = Sender.EditBox.value.substring(0,ReTab) , postText = Sender.EditBox.value.substring(Sender.EditBox.selectionStart);
      var word = preText.split(/\s+/g).pop();
      var toExp = word.replace(/(.)/g,(a,b)=>'\\x' + b.charCodeAt(0).toString(16));
      var exp = new RegExp("^(?:[" + Client.Prefix + "]+)?(" + toExp + ".*)","i");
      var Matches = [];
      if (Sender.hasOwnProperty('List')) {
        Sender.List.children().forEach((elem) => { if (exp.test(elem.innerText)) { Matches.push(RegExp.$1); } });

        if (Matches.length > 0) {
          var LastIndex = parseInt(Sender.EditBox.dataset.lastindex);
          if (isNaN(LastIndex) || LastIndex == (Matches.length - 1)) { LastIndex = -1; }
          LastIndex++;
          Sender.EditBox.value = preText.substr(0,preText.length - word.length) + Matches[LastIndex] + postText;
          Sender.EditBox.selectionStart = preText.length - word.length + Matches[LastIndex].length; 
          Sender.EditBox.selectionEnd = preText.length - word.length + Matches[LastIndex].length;
          Sender.EditBox.dataset.tabcomp = ReTab;
          Sender.EditBox.dataset.lastindex = LastIndex;
        }
      }
    }
    //clear tabcomp data and history scroll data on any keypress that isn't chr9
    else { Sender.EditBox.dataset.tabcomp = Sender.EditBox.dataset.lastindex = ''; Sender.EditBox.dataset.hindex = Sender._EditBoxHistory.length; }
  }
  _KeyBoard(e) {
    if (this.hasOwnProperty('MDI')) {
      var active = this.MDI.activeSubWindow();
      if (active && active.hasOwnProperty('Canvas') && !e.repeat) { e.preventDefault(); e.stopPropagation(); active.Canvas.dispatchEvent(new CustomEvent('keyboard',{ detail: { jsEvent: e } })); }
    }
  }
  _SendData(Client,Data) {
    if (Client.hasOwnProperty('Socket') && Client.Socket.readyState == 1) { Client.WSSend(Data); }
    else { this._Echo(Client.CID,"status window",1,'#FF0000',AscTime(new Date(),Client.Timestamp) + " * Error: not connected!"); }
  }
  _Color(type) { return (isNaN(this._Config['colors'][type]) ? this._Config['colors'][type] : this._Config['palette'][this._Config['colors'][type]]); }

  /*-------------------------------------------------------------------------------------------------
  Public Functions
  -------------------------------------------------------------------------------------------------*/
  CC2Html(linecolor,text,ii,ia,iy) {
    // === CC var is a direct rip of $rgb($color(N)) converted to base 16. N is 0-99 for all 100 new colors added to mIRC.
    var cc = this._Config['palette'];
    var b = 0, u = 0, r = 0 , i = 0, s = 0, bg = cc.length, fg = cc.length;

    text = text.replace(/([&<>])/g,(m,e) => { return "&#" + e.charCodeAt(0) + ";"; }).replace(/((?:https?|ftp):\/\/(?:[\w_-]+(?:(?:\.[\w_-]+)+))(?:[\w.,@?^=%&:/~+#-;]*[\w@?^=%&/~+#-])?)/ig,function(match,url) {   
      if (ii && /\.(?:bmp|cgm|g3|gif|ief|jpe?g?|png|btif|svgz?|tiff?|psd|djvu?|dwg|dxf|fbs|fpx|fst|mmr|rlc|mdi|npx|wbmp|xif|ras|cmx|ico|pcx|pic|pct|pnm|pbm|pgm|ppm|rgb|xbm|xpm|xwd)/i.test(url)) { return '<a href="' + url + '" target="_blank"><img alt="image" src="' + url + '" style="max-width: 300px; max-height: 300px; aspect-ratio: 300 / 300;"></a>'; }
      else if (ia && /\.(?:au|snd|midi?|kar|rmi|mp4a?|mpga?|mp?2a?|mp?3a?|eol|lvp|ecelp4800|ecelp7470|ecelp9600|wav|aif(?:f|c)?|m3u|wax|wma|ram?|rmp)/i.test(url)) { return '<audio controls src="' + url + '" style="text-indent: 0;"><a href="' + url + '">Download audio</a></audio>'; }
      else if (iy && /^https?:\/\/(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)/g.test(url)) { return '<iframe width="320" height="280" src="//www.youtube.com/embed/' + RegExp.$1 + '" frameborder="0" allowfullscreen></iframe>'; }
      return '<a href="' + url + '" target="_blank">' + url + '</a>'; 
    });
  
    var ret = text.replace(/(\x03(?:(?:\d\d?),)?(?:\d\d?)|[\x02\x03\x16\x1d\x1e\x0f\x1f])([^\x02\x03\x16\x1d\x1e\x0f\x1f]*)/g,function(match,control,string) {
      if (control == '\x03') { fg = bg = cc.length; } //Blank ctrl+k
      else if (control == '\x02') { b = !b } //ctrl+b (bold)
      else if (control == '\x1f') { u = !u }  //ctrl+u (underline)
      else if (control == '\x16') { var tmp = bg; bg = fg; fg = tmp; }  //ctrl+r (reverse)
      else if (control == '\x1d') { i = !i } //ctrl+i (italic)
      else if (control == '\x1e') { s = !s } //ctrl+s (strikethru)
      else if (control == '\x0f') { b = u = r = i = s = 0; fg = bg = cc.length; } //ctrl+o (stop all control codes)
      else { //ctrl+k (color)
        var fgt = /^\x03(\d\d?)$/.exec(control), bt = /^\x03(\d\d?),(\d\d?)$/.exec(control);
        if (Array.isArray(fgt) && fgt.length > 0) { fg = parseInt(fgt[1]) + 0; }
        else if (Array.isArray(bt) && bt.length > 0) { fg = parseInt(bt[1]) + 0; bg = parseInt(bt[2]) + 0; }
      }
      var style = (b ? 'font-weight:bold;' : '') + (u ? 'text-decoration:underline;' : (s ? 'text-decoration:line-through;' : '')) + (i ? 'font-style:italic;' : '') + (bg < cc.length ? 'background-color:' + cc[bg] + ';' : '') + (fg < cc.length ? 'color:' + cc[fg] + ';' : '');
      if (!style) { return string; }
      else { return "<span style=\"" + style + "\">" + string + "</span>"; }
    });
    return "<span style=\"color:" + (isNaN(linecolor) ? linecolor : cc[linecolor]) + "\">" + ret + "</span>";
  }

  onAction(cid,nick,address,target,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('action');
    if (Client.isChan(target)) {
      var IAL = Client.GetIAL(nick) , Line = "* " + (IAL ? IAL.channels[target.toLowerCase()].substr(0,1) : "") + nick + " " + msg;
      this._Echo(cid,target,2,LineColor,Line);
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
    }
    else {
      var Line = "* " + nick + "  " + msg; 
      if (nick == Client.Me) {
        if (!this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this._NewWindow(cid,target.toLowerCase(),{ "target": target, mdi: true, state: "normal", type: "query", cid: cid }); }
        this._Echo(cid,target,2,LineColor,Line);
      }
      else {
        if (!this.Windows[cid].Windows.hasOwnProperty(nick.toLowerCase())) { this._NewWindow(cid,nick.toLowerCase(),{ "target": nick, mdi: true, state: "normal", type: "query", cid: cid }); }
        this._Echo(cid,nick,2,LineColor,Line);
        this._MonitorEcho(this.MonitorQueryViewPort,'inherit',(Client.Network != "" ? Client.Network : Client.Server) + ": " + Line);
      }
    }
  }
  onConnect(cid) { 
    var Client = this.Windows[cid].Windows['status window']._Client , rejoin = [];
    Object.keys(this.Windows[cid].Windows).forEach((win) => {
      if (this.Windows[cid].Windows[win]._Type == "channel") {
        if (this.Windows[cid].Windows[win].List.children().length == 0) { rejoin.push(this.Windows[cid].Windows[win]._Name); }
      }
    });
    if (rejoin.length > 0) { this._SendData(Client,"JOIN " + rejoin.join(",")); }
  }
  onCtcp(cid,nick,address,target,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('ctcp');
    var win = "status window";
    if (Client.isChan(target)) { win = target; }
    this._Echo(cid,win,2,LineColor,"[" + nick + " " + msg + "]");
  }
  //TODO: Fix ctcp reply (remove Args)
  onCtcpReply(cid,nick,address,target,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('ctcp');
    var win = "status window";
    if (Client.isChan(target)) { win = target; }
    this._Echo(cid,win,2,LineColor,"[" + nick + (Client.isChan(target) ? ":" + target : "") + " " + Args[0] + " reply]: " + Args.slice(1).join(" "));
  }
  onLogon(cid) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('info');
    this._Echo(cid,"status window",1,LineColor,"* Connecting to " + Client.WSServerURI);
  }
  onDisconnect(cid) {
    if (this.Windows.hasOwnProperty(cid)) {
      var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('info');
      this._Echo(cid,"status window",1,LineColor,"* Disconnected");
      Object.keys(this.Windows[cid].Windows).forEach((win) => {
        if (this.Windows[cid].Windows[win]._Type == "channel") {
          this._Echo(cid,this.Windows[cid].Windows[win]._Name,1,LineColor,"* Disconnected");
          this.Windows[cid].Windows[win].List.children().forEach((nick) => { setTimeout(() => { this.Windows[cid].Windows[win].List.removeAction(nick); }); });
        }
      });
    }
  }
  onInvite(cid,nick,address,target) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('invite');
    this._Echo(cid,"status window",1,LineColor,"* " + nick + " invites you to: " + target);
  }
  onJoin(cid,nick,address,target) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('join');
    if (nick == Client.Me && !this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this._NewWindow(cid,target,{ "target": target, mdi: true, state: "normal", type: "channel", cid: cid , lb: 2 }); }
    else if (this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Windows[cid].Windows[target.toLowerCase()]._handleNickListEvent('join',nick); }
    var Line = "* Joins: " + nick + " (" + address + ")";
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onKick(cid,nick,address,target,knick,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('kick');
    if (this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Windows[cid].Windows[target.toLowerCase()]._handleNickListEvent('kick',knick); }
    var Line = "* " + knick + " was kicked by: " + nick + " (" + msg + ")";
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onMode(cid,nick,address,target,modes) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('mode');
    if (this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Windows[cid].Windows[target.toLowerCase()]._handleNickListEvent('mode',modes); }
    var Line = "* " + nick + " sets mode: " + modes;
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onNick(cid,nick,address,newnick) { 
    var Client = this.Windows[cid].Windows['status window']._Client , IAL = Client.GetIAL(newnick) , LineColor = this._Color('nick');
    if (IAL) { 
      var Line = "* " + nick + " is now known as " + newnick;
      Object.keys(IAL.channels).forEach((target) => { 
        if (this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Windows[cid].Windows[target.toLowerCase()]._handleNickListEvent('nick',nick,newnick); }
        this._Echo(cid,target,1,LineColor,Line);
      });
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + Object.keys(IAL.channels).join(",") + ": " + Line);
    }
    if (newnick == Client.Me) { 
      this._Echo(cid,"status window",1,LineColor,"* You are now known as " + newnick); 
      this.Windows[cid].Windows['status window']._updateTitle();
    }
  }
  onNotice(cid,nick,address,target,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('notice');
    var win = "status window";
    if (Client.isChan(target)) { win = target; }
    var Line = "-" + nick + (Client.isChan(target) ? ":" + target : "") + "- " + msg;
    this._Echo(cid,win,2,LineColor,Line);
    this._MonitorEcho(this.MonitorNoticeViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + (Client.isChan(target) ? " - " + target : "") + ": " + Line);
  }
  onPart(cid,nick,address,target,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('part');
    if (this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Windows[cid].Windows[target.toLowerCase()]._handleNickListEvent('part',nick); }
    var Line = "* Parts: " + nick + " (" + address + ")" + (msg ? " (" + msg + ")" : "");
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onPing(cid,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client;
  }
  onPong(cid,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client;
  }
  onQuit(cid,nick,address,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client, IAL = Client.GetIAL(nick) , LineColor = this._Color('quit');
    if (IAL) {
      var Line = "* Quits: " + nick + " (" + address + ") (" + msg + ")";
      Object.keys(IAL.channels).forEach((target) => {
        if (this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Windows[cid].Windows[target.toLowerCase()]._handleNickListEvent('quit',nick); }
        this._Echo(cid,target,1,LineColor,Line);
      });
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + Object.keys(IAL.channels).join(",") + ": " + Line);
    }
  }
  onPrivmsg(cid,nick,address,target,msg) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('normal');
    if (Client.isChan(target)) {
      var IAL = Client.GetIAL(nick);
      if (nick != Client.Me) { var Line = "12<14" + (IAL ? IAL.channels[target.toLowerCase()].substr(0,1) : "") + "" + nick + "12> " + msg; }
      else { var Line = "9<14" + IAL.channels[target.toLowerCase()].substr(0,1) + "" + nick + "9> " + msg; }
      this._Echo(cid,target,2,LineColor,Line);
      this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
    }
    else {
      if (nick == Client.Me) {
        if (!this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this._NewWindow(cid,target.toLowerCase(),{ "target": target, mdi: true, state: "normal", type: "query", cid: cid }); }
        var Line = "9<" + nick + "9> " + msg; 
        this._Echo(cid,target,2,LineColor,Line);
      }
      else {
        if (!this.Windows[cid].Windows.hasOwnProperty(nick.toLowerCase())) { this._NewWindow(cid,nick.toLowerCase(),{ "target": nick, mdi: true, state: "normal", type: "query", cid: cid }); }
        var Line = "12<" + nick + "12> " + msg; 
        this._Echo(cid,nick,2,LineColor,Line);
        this._MonitorEcho(this.MonitorQueryViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + ": " + Line);
      }
    }
  }
  onRaw(cid,numeric,msg) {
    var Client = this.Windows[cid].Windows['status window']._Client;
    var Tokens = msg.split(" ");
    if (numeric == "332") { this._Echo(cid,Tokens[1],1,this._Color('topic'),"* Topic is '" + Tokens.slice(2).join(" ") + "'"); }
    else if (numeric == "333") { this._Echo(cid,Tokens[1],1,this._Color('topic'),"* Set by " + Tokens[2] + " on " + AscTime(new Date(parseInt(Tokens[3]) * 1000),'ddd mmm dd HH:nn:ss yyyy')); }
    //Prevent these for now... caused by joining channels
    else if (numeric == "324") { } //Channel Modes
    else if (numeric == "329") { } //Channel Created
    else if (numeric == "353") { } //Channel names
    else if (numeric == "366") { 
      if (this.Windows.hasOwnProperty(cid) && this.Windows[cid].Windows.hasOwnProperty(Tokens[1].toLowerCase())) {
        var Chan = Client.GetICL(Tokens[1].toLowerCase());
        var UI = this.Windows[cid].Windows[Tokens[1].toLowerCase()];
        UI.List.children().forEach((child) => { setTimeout(() => { UI.List.removeAction(child); }); });
        Chan.Nicks.forEach((nick) => { 
          var IAL = Client.GetIAL(nick) , NickAction = new QAction('',IAL.channels[Chan.channel.toLowerCase()].substr(0,1) + nick,UI.List); 
          NickAction.dataset.nick = encodeURIComponent(nick);
	      });
        UI._updateTitle();
      }
    } //channel end of names
    else { this._Echo(cid,"status window",1,this._Color('normal'),Tokens.slice(1).join(" ")); }
  }
  onSnotice(cid,nick,address,target,msg) {
    var Client = this.Windows[cid].Windows['status window']._Client;
    //this._Echo(cid,target,1,'#009393',);
  }
  onSmode(cid,nick,address,target,modes) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('mode');
    if (this.Windows[cid].Windows.hasOwnProperty(target.toLowerCase())) { this.Windows[cid].Windows[target.toLowerCase()]._handleNickListEvent('mode',modes); }
    var Line = "* " + nick + " sets mode: " + modes;
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onTopic(cid,nick,address,target,topic) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('topic');
    var Line = "* " + nick + " changes topic to '" + topic + "'";
    this._Echo(cid,target,1,LineColor,Line);
    this._MonitorEcho(this.MonitorChanViewPort,LineColor,(Client.Network != "" ? Client.Network : Client.Server) + " - " + target + ": " + Line);
  }
  onUmode(cid,modes) { 
    var Client = this.Windows[cid].Windows['status window']._Client , LineColor = this._Color('mode');
    var Line = "* " + Client.Me + " set mode: " + modes;
    this._Echo(cid,"status window",1,LineColor,Line);
  }
}
// Define the new element
customElements.define('web-mdi', WebMDI);

class CustomWindow extends QMdiSubWindow {
  //constructor(mainapp,parent,treeparent,cid,name,type,lb,eb) {
  constructor(mainapp,cid,name,Data) {
    if (Data.mdi == "false") { super(document.body); }
    else { super(mainapp.MDI); }

    /*-------------------------------------------------------------------------------------------------
	  Private Properties
    -------------------------------------------------------------------------------------------------*/
	  this._Base.push("CustomWindow");
    this.classList.add("CustomWindow");
    this._MainApp = mainapp;
    this._CID = cid;
    this._Name = name;
    this._Target = Data.target;
    this._Type = Data.type;
    this._Highlight = 0;
    this.dataset.cid = cid;
    this.dataset.name = name;

    /*-------------------------------------------------------------------------------------------------
    Build UI Components
    -------------------------------------------------------------------------------------------------*/

    var IconURL = 'favicon.ico' , treeparent = this._MainApp.Treebar;
    if (/^(status|channel|query)$/i.test(Data.type)) { IconURL = "images/" + Data.type + ".ico"; }

    this.setWindowIcon(IconURL);
    this.setWindowTitle(this._MainApp.CC2Html('',Data.title || ''));
    if (Data.type != "status") { var treeparent = this._MainApp.Windows[cid].Windows['status window'].TreeItem; }
    else { 
      this._Client = new IRCClient(cid); 
      this._Client.addListener('action',this._MainApp,this._MainApp.onAction);
      this._Client.addListener('connect',this._MainApp,this._MainApp.onConnect);
      this._Client.addListener('ctcp',this._MainApp,this._MainApp.onCtcp);
      this._Client.addListener('ctcpreply',this._MainApp,this._MainApp.onCtcpReply);
      this._Client.addListener('disconnect',this._MainApp,this._MainApp.onDisconnect);
      this._Client.addListener('invite',this._MainApp,this._MainApp.onInvite);
      this._Client.addListener('join',this._MainApp,this._MainApp.onJoin);
      this._Client.addListener('kick',this._MainApp,this._MainApp.onKick);
      this._Client.addListener('logon',this._MainApp,this._MainApp.onLogon);
      this._Client.addListener('mode',this._MainApp,this._MainApp.onMode);
      this._Client.addListener('nick',this._MainApp,this._MainApp.onNick);
      this._Client.addListener('notice',this._MainApp,this._MainApp.onNotice);
      this._Client.addListener('part',this._MainApp,this._MainApp.onPart);
      this._Client.addListener('ping',this._MainApp,this._MainApp.onPing);
      this._Client.addListener('pong',this._MainApp,this._MainApp.onPong);
      this._Client.addListener('privmsg',this._MainApp,this._MainApp.onPrivmsg);
      this._Client.addListener('quit',this._MainApp,this._MainApp.onQuit);
      this._Client.addListener('raw',this._MainApp,this._MainApp.onRaw);
      this._Client.addListener('smode',this._MainApp,this._MainApp.onSmode);
      this._Client.addListener('snotice',this._MainApp,this._MainApp.onSnotice);
      this._Client.addListener('topic',this._MainApp,this._MainApp.onTopic);
      this._Client.addListener('umode',this._MainApp,this._MainApp.onUmode);
    }
    this.TreeItem = new QTreeWidgetItem(IconURL,Data.target,treeparent).connect('itemClicked',this,this._activate);
    if (Data.type == "status") { this.TreeItem.addEventListener('childEvent',this.handleEvent.bind(this)); }
    this.Container = QuickElement('div',{style: 'display: flex; flex-direction: column; flex: auto; overflow: hidden;'});

    if (Data.lb == "2") {
      this.ListDock = new QDockWidget((Data.type == 'channel' ? "Nicklist" : 'List')).setAllowedAreas(Qt.LeftDockWidgetArea | Qt.RightDockWidgetArea);
      this.List = new QListView(this.ListDock).setBaseSize(100,null);
      this.addDockWidget(Qt.RightDockWidgetArea,this.ListDock);
    }
    else if (Data.lb == "1") { this.List = new QListView(this.Container).setBaseSize(100,null); }

    if (/^(status|channel|query|custom)$/i.test(Data.type)) {
      this.ViewPort = QuickElement('div',{'class': 'viewport', style: "display: flex; flex-direction: column; background: inherit; flex: auto; text-indent: -1em; padding: 0 0 0 1.2em; word-wrap: break-word; white-space: pre-wrap; overflow-y: scroll;"});
      this.Container.appendChild(this.ViewPort);
    }
    if (Data.eb == "1" || /^(status|channel|query)$/i.test(Data.type)) {
      this.EditBox = QuickElement('input',{type: "text", style: "background: inherit; color: inherit; border: 1px solid transparent"});
      this.EditBox.addEventListener('keydown',(e) => { this._MainApp._handleInput(this,e); });
      this.EditBox.addEventListener('paste',(e) => { 
        var lines = event.clipboardData.getData('Text').split("\n");
        if (lines.length > 1) {
          e.stopPropagation();
          e.preventDefault();
          lines.forEach((line) => { this._MainApp._processInputLine(this,line); });
        }
        //console.log(lines); 
      });
      this.Container.appendChild(this.EditBox);
      this._EditBoxHistory = [];
    }
    this.setWidget(this.Container);
    if (Data.state == "hidden") {
      this.TreeItem.setVisible(false);
      this.setVisible(false);
    }

    /*-------------------------------------------------------------------------------------------------
    Setup Event Listeners
    -------------------------------------------------------------------------------------------------*/
    this.connect('aboutToActivate',this,() => { 
      this.TreeItem.setSelected();
      //this.TreeItem.style.color = 'inherit';
      this._Highlight = 0;
      this._scrollBottom();
    });
    this.addEventListener('childEvent',this.handleEvent.bind(this));
    this.setResizable(true);
  }

  /*-------------------------------------------------------------------------------------------------
  Default Callbacks and Event Handler
  -------------------------------------------------------------------------------------------------*/
  connectedCallback() { super.connectedCallback(); }
  disconnectedCallback() { super.disconnectedCallback(); }
  destructor() {
    var Client = this._MainApp.Windows[this._CID].Windows['status window']._Client;
    if (this._Name.toLowerCase() != "status window") { var treeparent = this._MainApp.Windows[this._CID].Windows['status window'].TreeItem; }
    else { var treeparent = this._MainApp.Treebar; }

    if (/^(channel)$/i.test(this._Type)) { this._MainApp._SendData(Client,"PART " + this._Name); }
    if (this._Type != "status") {
      treeparent.removeChild(this.TreeItem);
      if (this._Parent == this._MainApp.MDI) { this._MainApp.MDI.removeSubWindow(this); }
      else { document.body.removeChild(this); }
      delete this._MainApp.Windows[this._CID].Windows[this._Name.toLowerCase()];
    }
    else {
      Client.WSClose();
      this.TreeItem.parentNode.removeChild(this.TreeItem);
      Object.keys(this._MainApp.Windows[this._CID].Windows).forEach((win) => {
        var window = this._MainApp.Windows[this._CID].Windows[win];
        if (window._Parent == this._MainApp.MDI) { this._MainApp.MDI.removeSubWindow(window); }
        else { document.body.removeChild(window); }
      });
      delete this._MainApp.Windows[this._CID];
    }
  }
  handleEvent(e) { 
    super.handleEvent(e);
    if (e.type == 'childEvent') {
      if (e.detail.QEvent == QEvent.Resize) {
        if (this.hasOwnProperty('Canvas')) {
          this.Canvas.setAttribute('width',this.Container.offsetWidth);
          this.Canvas.setAttribute('height',this.Container.offsetHeight);
        }
      }
      if (e.detail.QEvent == QEvent.WindowStateChange) {
        if (!this.isWindow()) {
          this.addEventListener('pointerdown',(e) => { this._StartMove(e); });
          this.addEventListener('pointerup',(e) => { this._StopMove(e); });
          //console.log("Window State of @Window! Needs easy-move!");
        }
      }
      if (e.detail.QEvent == QEvent.Close) {
        this.destructor();
      }
      if (e.detail.QEvent == QEvent.ChildAdded) {
        if (Array.isArray(e.detail.target._Base) && e.detail.target._Base.includes('QTreeWidgetItem')) { setTimeout(() => { this._SortTree(this.TreeItem.children()); }); }        
        //console.log(e);
      }
    }
  }
 
  /*-------------------------------------------------------------------------------------------------
  Private Functions
  -------------------------------------------------------------------------------------------------*/
  _activate() {
    if (this._Parent != document.body) { this._Parent.setActiveSubWindow(this); } 
    this._Highlight = 0;
    this.TreeItem._TreeLabel.style.color = ['inherit','#0000FC','#FF0000'][this._Highlight];
    this._MainApp.Treebar.setCurrentItem(this.TreeItem);
    if (!window.mobileCheck()) { this.EditBox.focus(); }
  }
  _scrollBottom() { 
    var Client = this._MainApp.Windows[this._CID].Windows['status window']._Client;
    //We need to give the browser time to render, so a slight timeout before scrolling to the bottom is necessary...
    if (this.hasOwnProperty('ViewPort')) { 
      setTimeout(() => { this.ViewPort.scrollTop = this.ViewPort.scrollHeight; });
    }
    this._updateTitle();
  }
  _updateTitle() {
    var Client = this._MainApp.Windows[this._CID].Windows['status window']._Client;
    if (this._Type == "status") { 
      this.TreeItem.setText((Client.Network != "" ? Client.Network : (Client.Server != "" ? Client.Server : "Status")) + (Client.Me != "" ? " " + Client.Me : ""));
      this.setWindowTitle("Status: " + Client.Me + "[+" + Client.UMode + "] on " + Client.Network + " (" + Client.Server + ")"); 
    }
    else if (this._Type == "channel") {
      var Chan = Client.GetICL(this._Name);
      if (Chan) { this.setWindowTitle(this._Target + " (" + Client.Network + ") [" + Chan.Nicks.length + "] [+" + Chan.mode + "]: " + this._MainApp.CC2Html('inherit',Chan.topic)); }
    }
    else if (this._Type == "query") {
      var IAL = Client.GetIAL(this._Name);
      this.setWindowTitle(this._Target + " (" + Client.Network + ")" + (IAL ? " (" + IAL.address + ")" : ""));
    }
  }
  _echo(highlight,color,string) {
    var tmp = document.createElement('span') , shouldscroll = ((this.ViewPort.scrollTop + this.ViewPort.clientHeight) == this.ViewPort.scrollHeight ? true : false);
    tmp.innerHTML = this._MainApp.CC2Html(color,string,1,1,1) + "\n";
    this.ViewPort.appendChild(tmp);
    if (shouldscroll) { this._scrollBottom(); }
    if (!this.TreeItem.isSelected() && highlight > this._Highlight) { this._Highlight = highlight; }
    this.TreeItem._TreeLabel.style.color = ['inherit','#0000FC','#FF0000'][this._Highlight];
  }
  _loadBlob(blob) {
    var source = new Image();
    source.addEventListener('load', (e) => { this.Canvas.getContext('2d').drawImage(source,0,0,source.width,source.height); });
    source.addEventListener('error', () => { console.log('fuck! ' + blob); } );
    source.src = 'data:'+[blob];
  }
  _SortTree(array) {
    var Client = this._MainApp.Windows[this._CID].Windows['status window']._Client;
    var sorted = array.sort((a,b) => {
      var c = Client.ChanTypes.split("").indexOf(a._TreeLabel.innerText.substr(0,1)), d = Client.ChanTypes.split("").indexOf(b._TreeLabel.innerText.substr(0,1));
      var e = String.fromCharCode((c < 0 ? Client.ChanTypes.length : c) + 33) + a._TreeLabel.innerText , f = String.fromCharCode((d < 0 ? Client.ChanTypes.length : d) + 33) + b._TreeLabel.innerText;
      if (e.toLowerCase() < f.toLowerCase()) { return -1; }
      if (e.toLowerCase() > f.toLowerCase()) { return 1; }
      return 0;
    });
    sorted.forEach((item) => { item.parentNode.appendChild(item); });
  }
  _handleNickListEvent(event,nick,newnick) {
    var Client = this._MainApp.Windows[this._CID].Windows['status window']._Client , Chan = Client.GetICL(this._Name);
    if (/^(?:part|quit|kick)$/.test(event)) {
      var NickAction = this.List.querySelector("[data-nick='" + encodeURIComponent(nick) + "']");
      if (NickAction) { this.List.removeAction(NickAction); }
    }
    else if (event == 'join') {
      var IAL = Client.GetIAL(nick), Index = Chan.Nicks.indexOf(nick) + 1;
      if (IAL.channels.hasOwnProperty(this._Name.toLowerCase())) {
        var item = new QAction('',IAL.channels[this._Name.toLowerCase()].substr(0,1) + nick);
        item.dataset.nick = encodeURIComponent(nick);
        if (Index < Chan.Nicks.length) { this.List.insertAction(this.List.childNodes[Index],item); }
        else { this.List.addAction(item); }
      }
    }
    else if (event == 'nick') {
      var NickAction = this.List.querySelector("[data-nick='" + encodeURIComponent(nick) + "']");
      if (NickAction) {
        var IAL = Client.GetIAL(newnick) , Index = Chan.Nicks.indexOf(newnick) + 1;
        this.List.removeAction(NickAction);
        NickAction.setText(IAL.channels[this._Name.toLowerCase()].substr(0,1) + newnick);
        NickAction.dataset.nick = encodeURIComponent(newnick);
        if (Index < Chan.Nicks.length) { this.List.insertAction(this.List.childNodes[Index],NickAction); }
        else { this.List.addAction(NickAction); }
      }
    }
    else if (event == 'mode') {
      var nicks = new Set(nick.split(/ /).slice(1));
      nicks.forEach((Nick) => {
        if (Client.isOn(Nick,this._Name)) {
          var NickAction = this.List.querySelector("[data-nick='" + encodeURIComponent(Nick) + "']");
          if (NickAction) {
            var IAL = Client.GetIAL(Nick) , Index = Chan.Nicks.indexOf(Nick) + 1;
            this.List.removeAction(NickAction);
            NickAction.setText(IAL.channels[this._Name.toLowerCase()].substr(0,1) + Nick);
            NickAction.dataset.nick = encodeURIComponent(Nick);
            if (Index < Chan.Nicks.length) { this.List.insertAction(this.List.childNodes[Index],NickAction); }
            else { this.List.addAction(NickAction); }
          }
        }
      });
    }
  }

 /*-------------------------------------------------------------------------------------------------
  Public Functions
  -------------------------------------------------------------------------------------------------*/
}
customElements.define('web-customwindow', CustomWindow);

window.mobileCheck = function() {
  var check = false;
  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
  return check;
};

window.addEventListener('load',()=>{
  var Core = new WebMDI();
  window.addEventListener('keydown',Core._KeyBoard.bind(Core),false);
  window.addEventListener('keyup',Core._KeyBoard.bind(Core),false);
});
      </script>
    </head>
  <body>
  </body>
</html>